---
title: "Metabolite screen maize root bacteria"
subtitle: "Thoenen_et_al_Bacteria_BX_metabolization"
author: "Lisa Thönen"
date: "`r Sys.Date()`"
output: 
  html_document:
    fig_caption: yes
    # fig_height: 20
    # fig_width: 15
    toc: true
    toc_float: true
    theme: cerulean
    code_folding: show
editor_options: 
  chunk_output_type: console
---


Here we analyse the metabolite data from the maize root bacteria screening experiment in December 2019. 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,include=FALSE}
rm(list=ls())
```

```{r,include=FALSE}
# install.packages("dplyr")
# install.packages("magrittr")
# install.packages("ggplot2")
# install.packages("readxl")
# install.packages("stringr")
# install.packages("ggplot2")
# install.packages("tibble")
# install.packages("pheatmap")
# install.packages("ggdendro")
# install.packages("reshape2")
# install.packages("grid")
```

```{r,include=FALSE}
library("dplyr")
library("magrittr")
library("ggplot2")
library("readxl")
library("tidyr")
library("readr")
library("stringr")
library("ggplot2")
library("forcats")
library("ggpmisc")
library("pander")
library("tidyr")
library("tibble")
library("RColorBrewer")
library("pheatmap")
library("ggdendro")
library("reshape2")
library("grid")

# load functions
source("Input/functions/vennDia.R")
source("Input/functions/fun_venn_plot.R")
source("Input/functions/fun_venn_pair.R")
source("Input/functions/fun_venn_triple.R")
```

```{r, warning=F, echo=F, message=F}
metadata <- read.csv("Input/metadata60strains.csv", sep = ";")

database <- read_excel("Input/Database_MRB_isolates_sequences.xlsx")

# database %<>% dplyr::select(Strain,  Phylum, Class, Order, Family, Genus, Morphology_MBOA)

metadata$Genus <- gsub("Allorhizobium-Neorhizobium-Pararhizobium-Rhizobium", "Rhizobium", metadata$Genus) 

metadata$Genus[is.na(metadata$Genus)] = "no"
metadata$Phylum[is.na(metadata$Phylum)] = "no"
metadata$Genus <- gsub("Microbacterium", "Micrococcineae", metadata$Genus)
database$Genus <- gsub("Moraxellaceae", "Acinetobacter", database$Genus)


# unified taxonomy with chapter 1
metadata <- left_join(metadata %>% dplyr::select(Strain, Nr, Plate, Colour_Met), database, by = "Strain") %>% dplyr::select(Strain, strain_old, Nr, Plate, Colour_Met, isolation, Phylum, Class, Order, Family, Genus, Morphology_MBOA)

metadata$Family <- gsub("Pseudomonadales", "Moraxellaceae", metadata$Family)
```

```{r,include=FALSE}
BXData_all <- read.table("Input/20191209_BacBXD_quantified.txt", header = TRUE)
BXData_all %>% colnames()


# BXData$uMol_log <- log10(BXData$uMol)*-1

BXData_all$uMol[is.na(BXData_all$uMol)] = 0
BXData_all$Area[is.na(BXData_all$Area)] = 0
BXData_all$ng.mL_QuanLynx[is.na(BXData_all$ng.mL_QuanLynx)] = 0
BXData_all$ng.mL_adj[is.na(BXData_all$ng.mL_adj)] = 0

BXData_all$ng.mL_adj[is.na(BXData_all$ng.mL_adj)] = 0
# BXData_all$uMol_log[is.na(BXData_all$uMol_log)] = 0

# unify strain names across data tables
BXData_all$Strain <- gsub("LRC7-S", "LRC7.S", BXData_all$Strain)
BXData_all$Strain <- gsub("LRC7-O", "LRC7.O", BXData_all$Strain)
BXData_all$Strain <- gsub("LRH8-S", "LRH8.S", BXData_all$Strain)
BXData_all$Strain <- gsub("LRH8-O", "LRH8.O", BXData_all$Strain)
BXData_all$Strain <- gsub("LPB4-R", "LPB4.R", BXData_all$Strain)
BXData_all$Strain <- gsub("LPB4-O", "LPB4.O", BXData_all$Strain)

# filter out the LMI1 samples which were replicated in each qTOF run
BXData_all <- BXData_all %>% 
  filter(Name != "20191210_LT_NBC_MBOA") %>%
  filter(Name != "20191210_LT_NBC_DIMBOA") %>%
  filter(Name != "20191210_LT_NBC_DG") %>%
  filter(Name != "20191210_LT_NBC_Ctrl") %>%
  filter(Name != "20191210_LT_LMI1_MBOA_02") %>% 
  filter(Name != "20191210_LT_LMI1_MBOA") %>% 
  filter(Name != "20191211_LT_LMI1_MBOA") 
```

Some strains had to be excluded because they grew bad in the assay. This was checked by optical density measurement of the 96 well plates (which was prone to give false results because there condensed water forms below the lid which affects the measurements) and by measuring two amino acids in the cultures
```{r, warning=F, echo=F, message=F}
metadata %>% filter(Strain %in% c("LRH8.O", "LST17", "LMC1", "LMK1", "LME2", "LMX8", "LMX3", "LMX11")) %>% dplyr::select(Strain, Genus, Phylum, Colour_Met, Colour_Met) %>% knitr::kable()
```

```{r, warning=F, echo=F, message=F}
BXData_all %<>% filter(!Strain %in% c("LRH8.O", "LST17", "LMC1", "LMK1", "LME2", "LMX8", "LMX3", "LMX11"))
```

```{r,include=FALSE}
# Create separate tables for all the treatments & combine BXData table with metadata
# filter out strains with strange growth data

# MBOA
BXData <- BXData_all %>% filter(Treatment %in% "MBOA")
BXData <- left_join(BXData, metadata, by = "Strain")
# BXData <- BXData %>% filter(Strain != "LRH8.O")
# BXData <- BXData %>% filter(Strain != "LRH8.S")
BXData <- BXData %>% filter(Strain != "LRH8")
BXData <- BXData %>% filter(Strain != "LMC1")
BXData <- BXData %>% filter(Strain != "LMK1")
BXData <- BXData %>% filter(Strain != "LME2")
BXData <- BXData %>% filter(Strain != "LMX8")
BXData$Genus_Strain <- as.factor(paste(BXData$Genus, BXData$Strain, sep="_") )

# DIMBOA
BXData_DIMBOA <- BXData_all %>% filter(Treatment %in% "DIMBOA")
BXData_DIMBOA <- left_join(BXData_DIMBOA, metadata, by = "Strain")
# BXData_DIMBOA <- BXData_DIMBOA %>% filter(Strain != "LRH8.O")
# BXData_DIMBOA <- BXData_DIMBOA %>% filter(Strain != "LRH8.S")
BXData_DIMBOA <- BXData_DIMBOA %>% filter(Strain != "LMC1")
BXData_DIMBOA <- BXData_DIMBOA %>% filter(Strain != "LMK1")
BXData_DIMBOA <- BXData_DIMBOA %>% filter(Strain != "LME2")
BXData_DIMBOA <- BXData_DIMBOA %>% filter(Strain != "LMX8")
BXData_DIMBOA$Genus_Strain <- as.factor(paste(BXData_DIMBOA$Genus, BXData_DIMBOA$Strain, sep="_") )

# DIMBOA-Glc
BXData_DG <- BXData_all %>% filter(Treatment %in% "DG")
BXData_DG <- left_join(BXData_DG, metadata, by = "Strain")
# BXData_DG <- BXData_DG %>% filter(Strain != "LRH8.O")
# BXData_DG <- BXData_DG %>% filter(Strain != "LRH8.S")
BXData_DG <- BXData_DG %>% filter(Strain != "LMC1")
BXData_DG <- BXData_DG %>% filter(Strain != "LMK1")
BXData_DG <- BXData_DG %>% filter(Strain != "LME2")
BXData_DG <- BXData_DG %>% filter(Strain != "LMX8")
BXData_DG$Genus_Strain <- as.factor(paste(BXData_DG$Genus, BXData_DG$Strain, sep="_") )
```

```{r, warning=F, echo=F, message=F, include=F}
# extract the NBC data for each compound (later used for calculation of % compound metabolized)
MBOA_NBC <- BXData_all %>% filter(Strain %in% "NBC", Treatment %in% "MBOA", Compound_name %in% "MBOA", Block %in% "1")
MBOA_NBC$uMol

DIMBOA_NBC <- BXData_all %>% filter(Strain %in% "NBC", Treatment %in% "DIMBOA", Compound_name %in% "DIMBOA", Block %in% "1")
DIMBOA_NBC$uMol

DIMBOA_NBC_MBOA <- BXData_all %>% filter(Strain %in% "NBC", Treatment %in% "DIMBOA", Compound_name %in% "MBOA", Block %in% "1")
DIMBOA_NBC_MBOA$uMol

DIMBOAGlc_NBC <- BXData_all %>% filter(Strain %in% "NBC", Treatment %in% "DG", Compound_name %in% "DIMBOA-Glc", Block %in% "1")
DIMBOAGlc_NBC$uMol
```

**Dilutions**

All the samples (except T0 samples) were diluted with 100 % MeOH in a ratio (30:70 - sample:MeOH). Then they were diluted 1:6 in the pooled eppi and 1:10 in the analysis vial, resulting in a final dilution of 200. The T0 samples were diluted 1:6. Therefore the values have to be adjusted to the dilution.

```{r, warning=F, echo=F, message=F, include=F}
BXData_all %<>%
  mutate(uMol = case_when(Strain != "T0" & uMol != 0  ~ uMol*200,
                          Strain == "T0" ~ uMol))

BXData_all %<>%
  mutate(uMol = case_when(Strain == "T0" & uMol != 0  ~ uMol*6,
                          Strain != "T0" ~ uMol))

BXData_all %>% filter(Strain %in% "NBC", Compound_name %in% "MBOA")
 
BXData_all %>% filter(Strain %in% "T0", Compound_name %in% "MBOA")
 
BXData %<>%
  mutate(uMol = case_when(Strain != "T0" & uMol != 0  ~ uMol*200,
                          Strain == "T0" ~ uMol))

BXData %<>%
  mutate(uMol = case_when(Strain == "T0" & uMol != 0  ~ uMol*6,
                          Strain != "T0" ~ uMol))

BXData_DIMBOA %<>%
  mutate(uMol = case_when(Strain != "T0" & uMol != 0  ~ uMol*200,
                          Strain == "T0" ~ uMol))

BXData_DIMBOA %<>%
  mutate(uMol = case_when(Strain == "T0" & uMol != 0  ~ uMol*6,
                          Strain != "T0" ~ uMol))

BXData_DG %<>%
  mutate(uMol = case_when(Strain != "T0" & uMol != 0  ~ uMol*200,
                          Strain == "T0" ~ uMol))

BXData_DG %<>%
  mutate(uMol = case_when(Strain == "T0" & uMol != 0  ~ uMol*6,
                          Strain != "T0" ~ uMol))
```

# BX profiles of media controls
Benzoxazinoids were mixed to TSB growth media, each at a concentration of 500 uM. BXs were MBOA, DIMBOA and DIMBOA-Glc. 
The treatments were diluted and frozen directly at the start of the experiment (T0) and incubated without bacteria throughout the experiment (NBC). The T0 samples were differently diluted at the beginning, therefore they were here normalized with MBOA values (*35) - MBOA is stable in these conditions. 
NBC and T0 plotted show the spontaneous degradation of the BXs in the culture growth conditions. 

MBOA seems to be pure and stable over the course of the experiment. DIMBOA is not stable and degrades completly to MBOA. As the profile shows at T0 it is not pure and also contains HMBOA which degrades to BOA. 

DIMBOA-Glc is stable but not pure. 
```{r, warning=F, echo=F, message=F}
BXData_all %>% mutate(Compound_name = as.factor(Compound_name)) %>% mutate(Strain = as.factor(Strain)) %>% 
  # mutate(uMol = case_when(Strain == "T0" & uMol != 0  ~ uMol/33.3,
  #                         Strain != "T0" ~ uMol)) %>% 
  filter(Strain %in% c("T0", "NBC")) %>%
  ggplot(aes(x = Compound_name, y = uMol)) + 
  geom_bar(aes(fill = Strain), position = "dodge", stat = "summary", show.legend = TRUE) +
  facet_grid(~Treatment, scales = "free_y") +
  theme_bw() +
  theme(axis.text.x=element_text(angle = -90, hjust = 0, vjust = 0.5 )) +
  labs(x = "",
       fill = "")
```

```{r, warning=F, echo=F, message=F}
media.To <- BXData_all %>% mutate(Compound_name = as.factor(Compound_name)) %>% mutate(Strain = as.factor(Strain)) %>% 
  # mutate(uMol = case_when(Strain == "T0" & uMol != 0  ~ uMol/33.3,
  #                         Strain != "T0" ~ uMol)) %>% 
  filter(Strain %in% c("T0", "NBC")) %>%
  mutate(Treatment = gsub("DG", "DIMBOA-Glc", Treatment)) %>% 
  ggplot(aes(x = Compound_name, y = uMol)) + 
  geom_bar(aes(fill = Strain), position = "dodge", stat = "summary", show.legend = TRUE) +
  facet_grid(~Treatment, scales = "free_y") +
  theme_bw() +
  theme(strip.background = element_rect(color = NULL, fill= "white", linetype="solid"), strip.text.x = element_text(size = 16/.pt, margin = margin(1, 1, 1, 1)))+
  theme(axis.text.x=element_text(size = 16/.pt, angle = -90, hjust = 0, vjust = 0.5),
        axis.text.y=element_text(size = 16/.pt),
        axis.title = element_text(size = 16/.pt)) +
  scale_fill_manual(values = c("grey20", "grey60"))+
  labs(x = "",
       y = "concentration [uM]",
       fill = "")

media.To

# ggsave(plot = media.To, filename = "media.To.pdf", width = 17.6, height = 6, dpi = 300, scale = 1, units = "cm")
# 
# ggsave(plot = media.To, filename = "media.To.svg", width = 17.6, height = 6, dpi = 300, scale = 1, units = "cm")
```

# All metabolites in the cultures
## Quantitative analysis
### Bargraphs

```{r, warning=F, echo=F, message=F}
BXData_all$cols <- as.character(BXData_all$Compound_name)
BXData_all[BXData_all$Compound_name == "AMPO", ]$cols <- "darkred"
BXData_all[BXData_all$Compound_name == "AAMPO", ]$cols <- "firebrick1"
# BXData_all[BXData_all$Compound_name == "MHPA", ]$cols <- "gold2"
BXData_all[BXData_all$Compound_name == "MBOA", ]$cols <- "darkblue"

BXData_all[BXData_all$Compound_name == "DIM2BOA-Glc", ]$cols <-  "sandybrown"
BXData_all[BXData_all$Compound_name == "DIMBOA-Glc", ]$cols <-  "darkorange2"
BXData_all[BXData_all$Compound_name == "DIMBOA", ]$cols <-  "tan"
BXData_all[BXData_all$Compound_name == "BOA", ]$cols <- "slateblue"

BXData_all[BXData_all$Compound_name == "APO", ]$cols <-  "pink"
BXData_all[BXData_all$Compound_name == "AAPO", ]$cols <-  "pink3"

BXData_all[BXData_all$Compound_name == "HDM2BOA-Glc", ]$cols <-  "thistle1"
BXData_all[BXData_all$Compound_name == "HDMBOA-Glc", ]$cols <-  "thistle3"

BXData_all[BXData_all$Compound_name == "HM2BOA-Glc", ]$cols <-  "skyblue4"
BXData_all[BXData_all$Compound_name == "HMBOA-Glc", ]$cols <-  "skyblue2"
BXData_all[BXData_all$Compound_name == "HMBOA", ]$cols <- "skyblue"

temp <- data.frame(BXData_all$Compound_name, BXData_all$cols)
temp <- plyr::ddply(temp, .variables="BXData_all.Compound_name", .fun=unique)   #library(plyr)
level_cols_Compound <- as.character(temp[,2])
names(level_cols_Compound) <- temp[,1]
```

```{r, warning=F, echo=F, message=F, include=F}
BXData_all_tax <- left_join(BXData_all, metadata %>% dplyr::select(Strain, Genus, Family, Phylum), by = "Strain")
```


```{r, warning=F, echo=F, message=F}
DG.bargraph <- BXData_all_tax %>% 
  mutate(Strain_Genus = interaction(Strain, Genus)) %>% 
  filter(Strain != "T0") %>% 
  filter(Treatment %in% c("DG")) %>% 
  mutate(Treatment = gsub("DG", "DIMBOA-Glc", Treatment)) %>% 
  filter(Strain != "Standard") %>% 
  ggplot(aes(y = uMol, x = fct_rev(Strain_Genus))) + 
  geom_bar(aes(fill = Compound_name), position = "stack", stat = "summary", fun.y ="mean") +
  scale_fill_manual(values = level_cols_Compound) +
  theme_bw() +
  scale_y_continuous(expand = expansion(mult = c(0, 0)))+
  theme(strip.background = element_rect(color = NULL, fill= "white", linetype="solid"), strip.text.x = element_text(size = 16/.pt, margin = margin(1, 1, 1, 1)))+
  theme(axis.text.x=element_text(size = 16/.pt, angle = -90, hjust = 0, vjust = 0.5),
        axis.text.y=element_text(size = 16/.pt),
        axis.title = element_text(size = 16/.pt)) +
  coord_flip()+
  labs(x = "",
       y = "concentration [µMol]",
       fill = "")

DG.bargraph

# ggsave(plot = DG.bargraph, filename = "DG.bargraph.pdf", width = 9, height = 10, dpi = 300, scale = 1, units = "cm")
# 
# ggsave(plot = DG.bargraph, filename = "DG.bargraph.svg", width = 9, height = 10, dpi = 300, scale = 1, units = "cm")
```

```{r, warning=F, echo=F, message=F, include=F}
MBOA.bargraph <- BXData_all_tax %>% 
  # dplyr::arrange(desc(Genus)) %>% 
  # dplyr::arrange(desc(Strain)) %>% 
  mutate(Strain_Genus = interaction(Strain, Genus)) %>% 
  filter(Strain != "T0") %>% 
  # filter(Strain %in% c("LML1", "NBC")) %>% 
  filter(Treatment %in% c("MBOA")) %>% 
  mutate(Treatment = gsub("MBOA", "DIMBOA-Glc", Treatment)) %>% 
  # mutate(Strain = gsub(NA, "NBC", Strain)) %>% 
  # filter(Genus != "Pseudomonas") %>% 
  filter(Strain != "Standard") %>% 
  ggplot(aes(y = uMol, x = fct_rev(Strain_Genus))) + 
  geom_bar(aes(fill = Compound_name), position = "stack", stat = "summary", fun.y ="mean") +
  # facet_wrap(~Treatment, nrow = 3) +
  # scale_fill_viridis_d(option = "cividis")+
  # scale_color_brewer(palette = "Set1") +
  scale_fill_manual(values = level_cols_Compound) +
  # scale_x_reverse()+
  theme_bw() +
  scale_y_continuous(expand = expansion(mult = c(0, 0)))+
  theme(strip.background = element_rect(color = NULL, fill= "white", linetype="solid"), strip.text.x = element_text(size = 16/.pt, margin = margin(1, 1, 1, 1)))+
  theme(axis.text.x=element_text(size = 16/.pt, angle = -90, hjust = 0, vjust = 0.5),
        axis.text.y=element_text(size = 16/.pt),
        axis.title = element_text(size = 16/.pt)) +
  coord_flip()+
  labs(x = "",
       y = "concentration [µMol]",
       fill = "")

MBOA.bargraph

# ggsave(plot = MBOA.bargraph, filename = "MBOA.bargraph.pdf", width = 9, height = 10, dpi = 300, scale = 1, units = "cm")
# 
# ggsave(plot = MBOA.bargraph, filename = "MBOA.bargraph.svg", width = 9, height = 10, dpi = 300, scale = 1, units = "cm")
```

```{r, warning=F, echo=F, message=F}
AMPO.DG.bargraph <- BXData_all_tax %>% 
  # dplyr::arrange(desc(Genus)) %>% 
  # dplyr::arrange(desc(Strain)) %>% 
  mutate(Strain_Genus = interaction(Strain, Genus)) %>% 
  filter(Strain != "T0") %>% 
  filter(Compound_name %in% c("AMPO", "AAMPO")) %>% 
  filter(Treatment %in% c("DG")) %>% 
  mutate(Treatment = gsub("DG", "DIMBOA-Glc", Treatment)) %>% 
  # mutate(Strain = gsub(NA, "NBC", Strain)) %>% 
  # filter(Genus != "Pseudomonas") %>% 
  filter(Strain != "Standard") %>% 
  ggplot(aes(y = uMol, x = fct_rev(Strain_Genus))) + 
  geom_bar(aes(fill = Compound_name), position = "stack", stat = "summary", fun.y ="mean") +
  # facet_wrap(~Treatment, nrow = 3) +
  # scale_fill_viridis_d(option = "cividis")+
  # scale_color_brewer(palette = "Set1") +
  scale_fill_manual(values = level_cols_Compound) +
  # scale_x_reverse()+
  theme_bw() +
  scale_y_continuous(expand = expansion(mult = c(0, 0)))+
  theme(strip.background = element_rect(color = NULL, fill= "white", linetype="solid"), strip.text.x = element_text(size = 16/.pt, margin = margin(1, 1, 1, 1)))+
  theme(axis.text.x=element_text(size = 16/.pt, angle = -90, hjust = 0, vjust = 0.5),
        axis.text.y=element_text(size = 16/.pt),
        axis.title = element_text(size = 16/.pt)) +
  coord_flip()+
  labs(x = "",
       y = "concentration [µMol]",
       fill = "")

AMPO.DG.bargraph

# ggsave(plot = AMPO.DG.bargraph, filename = "AMPO.DG.bargraph.pdf", width = 9, height = 10, dpi = 300, scale = 1, units = "cm")
# 
# ggsave(plot = AMPO.DG.bargraph, filename = "AMPO.DG.bargraph.svg", width = 9, height = 10, dpi = 300, scale = 1, units = "cm")
```


```{r, warning=F, echo=F, message=F}
AMPO.MBOA.bargraph <- BXData_all_tax %>% 
  # dplyr::arrange(desc(Genus)) %>% 
  # dplyr::arrange(desc(Strain)) %>% 
  mutate(Strain_Genus = interaction(Strain, Genus)) %>% 
  filter(Strain != "T0") %>% 
  filter(Compound_name %in% c("AMPO", "AAMPO")) %>% 
  filter(Treatment %in% c("MBOA")) %>% 
  mutate(Treatment = gsub("MBOA", "DIMBOA-Glc", Treatment)) %>% 
  # mutate(Strain = gsub(NA, "NBC", Strain)) %>% 
  # filter(Genus != "Pseudomonas") %>% 
  filter(Strain != "Standard") %>% 
  ggplot(aes(y = uMol, x = fct_rev(Strain_Genus))) + 
  geom_bar(aes(fill = Compound_name), position = "stack", stat = "summary", fun.y ="mean") +
  # facet_wrap(~Treatment, nrow = 3) +
  # scale_fill_viridis_d(option = "cividis")+
  # scale_color_brewer(palette = "Set1") +
  scale_fill_manual(values = level_cols_Compound) +
  # scale_x_reverse()+
  theme_bw() +
  scale_y_continuous(expand = expansion(mult = c(0, 0)))+
  theme(strip.background = element_rect(color = NULL, fill= "white", linetype="solid"), strip.text.x = element_text(size = 16/.pt, margin = margin(1, 1, 1, 1)))+
  theme(axis.text.x=element_text(size = 16/.pt, angle = -90, hjust = 0, vjust = 0.5),
        axis.text.y=element_text(size = 16/.pt),
        axis.title = element_text(size = 16/.pt)) +
  coord_flip()+
  labs(x = "",
       y = "concentration [µMol]",
       fill = "")

AMPO.MBOA.bargraph

# ggsave(plot = AMPO.MBOA.bargraph, filename = "AMPO.MBOA.bargraph.pdf", width = 9, height = 10, dpi = 300, scale = 1, units = "cm")
# 
# ggsave(plot = AMPO.MBOA.bargraph, filename = "AMPO.MBOA.bargraph.svg", width = 9, height = 10, dpi = 300, scale = 1, units = "cm")
```

### Heatmap
```{r, warning=F, echo=F, message=F}
colsBlue <- c("#ffffff", "#edf8b1", "#c7e9b4", "#7fcdbb", "#41b6c4", "#1d91c0", "#225ea8", "#253494", "#081d58", "#800026", "#bd0026")

paletteLength <- 20
myColor <- colorRampPalette(colsBlue)(paletteLength)
# length(breaks) == length(paletteLength) + 1
# use floor and ceiling to deal with even/odd length pallettelengths
```

Genus information
```{r, warning=F, echo=F, message=F}
# Create Genusinfo for the heatmap annotation
BXStrainGenusinfo <- data.frame(metadata$Strain, metadata$Genus, metadata$Phylum, metadata$Family)

BXStrainGenusinfo %<>% 
  dplyr::rename(
     Strain = metadata.Strain,
     Genus = metadata.Genus,
     Phylum = metadata.Phylum,
     Family = metadata.Family) %>% 
  set_rownames(.$Strain) %>% dplyr::select(Genus, Family, Phylum) 

# define colours for the heatmap annotation
colGenusM = list(
    Genus = c(Acinetobacter = "lightcoral",
              Bacillus = "darkslategrey", 
              Chitinophaga = "khaki3", 
              Enterobacter = "brown", 
              # Microbacterium = "#s", # Change to Micrococcinae
              Micrococcineae = "darkslateblue", 
              Nocardioides = "skyblue",
              Pantoea = "seagreen", 
              Pseudarthrobacter = "orange",
              Pseudomonas = "darkred",
              Rhizobium = "gold3",
              Sphingobium = "maroon", 
              Stenotrophomonas = "cadetblue3", 
              Streptomyces = "azure4",
              no = "brown"))


# the used colors
colGenusMo = list(
    Genus = c(Acinetobacter = "lightcoral",
              Bacillus = "orange3",
              Chitinophaga = "khaki",
              Enterobacter = "tomato3",
              # Microbacterium = "#s", # Change to Micrococcinae
              Micrococcineae = "darkslateblue",
              Nocardioides = "skyblue",
              Pantoea = "seagreen",
              Pseudarthrobacter = "darkslategrey",
              Pseudomonas = "darkred",
              Rhizobium = "gold2",
              Sphingobium = "maroon3",
              Stenotrophomonas = "steelblue",
              Streptomyces = "azure4",
              no = "black"),
    Phylum = c(Firmicutes = "grey0",
              Actinobacteria = "dimgrey",
              Proteobacteria = "grey75",
              Bacteroidetes =  "grey100", 
              no = "black"))


colGenusM2 = list(
    Genus = c(Acinetobacter = "#fcbba1",
              Bacillus = "#fee391", 
              Chitinophaga = "#a8ddb5", 
              Enterobacter = "#f16913", 
              # Microbacterium = "#s", # Change to Micrococcinae
              Micrococcineae = "#d9f0a3", 
              Nocardioides = "#a6bddb",
              Pantoea = "#fec44f", 
              Pseudarthrobacter = "#a63603",
              Pseudomonas = "#bcbddc",
              Rhizobium = "gold3",
              Sphingobium = "#df65b0", 
              Stenotrophomonas = "#a6bddb", 
              Streptomyces = "#fcc5c0",
              no = "#969696"))

```

```{r, warning=F, echo=F, message=F}
BXStrainGenusinfo2 <- metadata %>% dplyr::select(Strain, Family, Phylum) %>% set_rownames(.$Strain) %>% dplyr::select(-Strain)
  
colsFamilyPhylum_2 = list(
  Family = c(Bacillaceae = "#004586",
              Moraxellaceae = "#a73e62",
              Rhizobiaceae = "#ff950e",
              Xanthomonadaceae = "#0084d1",
              Microbacteriaceae = "#7e0021",
              Pseudomonadaceae = "#4b1f6f",
              Nocardioidaceae = "#314004",
              Streptomycetaceae = "#8b995a",
              Enterobacteriaceae = "#ffd320",
              Sphingomonadaceae = "#c5000b",
              Micrococcaceae = "#83caff",
              Paenibacillaceae = "#8f9ec9",
              Chitinophagales = "#ff420e",
              Erwiniaceae = "#579d1c"),
              # NA = "white"),
    Phylum = c(Firmicutes = "grey0",
              Actinobacteriota = "dimgrey",
              Actinobacteria = "dimgrey",
              Proteobacteria = "grey75",
              Bacteroidetes =  "grey100", 
              no = "black"))

             # NA = "white"))

BXStrainGenusinfo_fam2 <- metadata %>% filter(!Strain %in% "NBC") %>% dplyr::select(Strain, Family) %>% set_rownames(.$Strain) %>% dplyr::select(-Strain)



colsFamily_2 = list(
  Family = c(Bacillaceae = "#004586",
              Moraxellaceae = "#a73e62",
              Rhizobiaceae = "#ff950e",
              Xanthomonadaceae = "#0084d1",
              Microbacteriaceae = "#7e0021",
              Pseudomonadaceae = "#4b1f6f",
              Nocardioidaceae = "#314004",
              Streptomycetaceae = "#8b995a",
              Enterobacteriaceae = "#ffd320",
              Sphingomonadaceae = "#c5000b",
              Micrococcaceae = "#83caff",
              Paenibacillaceae = "#8f9ec9",
              Chitinophagales = "#ff420e",
              Erwiniaceae = "#579d1c"))
```

```{r, warning=F, echo=F, message=F}
BXData_all$Treat_Compound_name <- as.factor(paste(BXData_all$Treatment, BXData_all$Compound_name, sep="_") )
# levels(BXData_all$Treat_Compound_name)

BXData_all_long <- BXData_all %>% 
  filter(Strain != "T0") %>%
  # filter(Strain != "NBC") %>% 
  # filter(Strain != "LRH8.O") %>% 
  # filter(Strain != "LRH8.S") %>% 
  # filter(Strain != "LRH8") %>% 
  filter(Strain != "LST17") %>% 
  filter(Strain != "LMC1") %>% 
  filter(Strain != "LMK1") %>% 
  filter(Strain != "LME2") %>% 
  filter(Strain != "LMX8") %>% 
  # filter(Strain != "LMX3") %>% 
  filter(Strain != "LMX11") %>% 
  filter(Strain != "Standard") %>% 
  filter(Name != "20191210_LT_LMI1_MBOA_02") %>% 
  filter(Name != "20191210_LT_LMI1_MBOA") %>% 
  filter(Name != "20191211_LT_LMI1_MBOA") %>% 
  filter(Treat_Compound_name %in% c("MBOA_MBOA", "MBOA_AMPO", "MBOA_AAMPO", "DG_AAMPO", "DG_AMPO", "DG_BOA", "DG_DIM2BOA-Glc", "DG_DIMBOA", "DG_DIMBOA-Glc", "DG_HDM2BOA-Glc", "DG_HMBOA", "DG_HMBOA-Glc", "DG_MBOA", "DIMBOA_AAMPO", "DIMBOA_AMPO", "DIMBOA_APO", "DIMBOA_BOA", "DIMBOA_DIMBOA", "DIMBOA_HDM2BOA-Glc", "DIMBOA_HMBOA", "DIMBOA_MBOA")) %>% 
  dplyr::select(Strain, Treat_Compound_name, uMol) %>%  
  distinct %>% tidyr::spread(Treat_Compound_name, uMol) %>% 
  column_to_rownames("Strain") 

BXData_all_long.matrix <- as.matrix(BXData_all_long)
BXData_all_long.matrix[is.na(BXData_all_long.matrix)] = 0

# Change col order
BXcolsall <- c("DG_DIMBOA-Glc", "DG_DIM2BOA-Glc", "DG_DIMBOA",  "DG_HDM2BOA-Glc",  "DG_HMBOA-Glc", "DG_HMBOA", "DG_MBOA","DG_BOA", "DG_AMPO", "DG_AAMPO",
               "DIMBOA_DIMBOA", "DIMBOA_HDM2BOA-Glc","DIMBOA_HMBOA",        "DIMBOA_MBOA", "DIMBOA_BOA", "DIMBOA_AMPO","DIMBOA_AAMPO", "DIMBOA_APO", 
               "MBOA_MBOA", "MBOA_AMPO", "MBOA_AAMPO")

BXData_all_long.matrix <- BXData_all_long.matrix[, BXcolsall]

paletteLength <- 300
myColor <- colorRampPalette(colsBlue)(paletteLength)
# length(breaks) == length(paletteLength) + 1
# use floor and ceiling to deal with even/odd length pallettelengths
myBreaks <- c(seq(0, 0.000178634, length.out=ceiling(paletteLength/2) + 1), 
              seq(max(BXData_all_long.matrix)/paletteLength, max(BXData_all_long.matrix), length.out=floor(paletteLength/2)))
pheatmap(BXData_all_long.matrix, color=myColor, breaks=myBreaks, cutree_rows = 8, gaps_col = c(10, 18), fontsize = 8, cluster_cols = FALSE, cluster_rows = TRUE, annotation_row = BXStrainGenusinfo_fam2, annotation_colors = colsFamily_2)
```

```{r, warning=F, echo=F, message=F}
# Prepare data
# make long
BXData_long_mol <- BXData %>% filter(Strain != "T0") %>% filter(Strain != "Standard") %>%  filter(Treatment %in% "MBOA") %>% filter(Name != "20191210_LT_LMI1_MBOA_02") %>% filter(Name != "20191211_LT_LMI1_MBOA") %>%  filter(Name != "20191210_LT_NBC_MBOA") %>% dplyr::select(Strain, Compound_name, uMol) %>%  distinct %>% tidyr::spread(Compound_name, uMol) %>% column_to_rownames("Strain")

BXData_long_mol.matrix <- as.matrix(BXData_long_mol)
BXData_long_mol.matrix[is.na(BXData_long_mol.matrix)] = 0

# Change colum order
BXcols <- c("HDMBOA-Glc", "HDM2BOA-Glc", "DIMBOA-Glc", "DIM2BOA-Glc", "HMBOA-Glc", "HM2BOA-Glc", "DIMBOA", "HMBOA", "MBOA", "AMPO", "AAMPO", "BOA", "APO", "AAPO")

BXData_long_mol.matrix <- BXData_long_mol.matrix[, BXcols]

myBreaks <- c(seq(0, 0.000178634, length.out=ceiling(paletteLength/2) + 1), 
              seq(max(BXData_long_mol.matrix)/paletteLength, max(BXData_long_mol.matrix), length.out=floor(paletteLength/2)))
pheatmap(BXData_long_mol.matrix, color=myColor, breaks=myBreaks, cutree_rows = 15, fontsize = 8, cluster_cols = FALSE, cluster_rows = TRUE, annotation_row = BXStrainGenusinfo_fam2, annotation_colors = colsFamily_2, main = "MBOA")
```

```{r, warning=F, echo=F, message=F}
# Prepare data
# make long
BXData_long_mol <- BXData %>% filter(Strain != "T0") %>% 
  filter(Strain != "Standard") %>%  
  filter(Treatment %in% "MBOA") %>% 
  filter(Name != "20191210_LT_LMI1_MBOA_02") %>% 
  filter(Name != "20191211_LT_LMI1_MBOA") %>%  
  filter(Name != "20191210_LT_NBC_MBOA") %>%
  filter(Treatment %in% "MBOA") %>% 
  filter(Compound_name %in% c("MBOA", "AMPO", "AAMPO")) %>% 
  dplyr::select(Strain, Compound_name, uMol) %>%  
  unique() %>% 
  tidyr::spread(Compound_name, uMol) %>% 
  column_to_rownames("Strain")

BXData_long_mol.matrix <- as.matrix(BXData_long_mol)
BXData_long_mol.matrix[is.na(BXData_long_mol.matrix)] = 0

# Change colum order
BXcols <- c("MBOA", "AMPO", "AAMPO")

BXData_long_mol.matrix <- BXData_long_mol.matrix[, BXcols]

myBreaks <- c(seq(0, 0.000178634, length.out=ceiling(paletteLength/2) + 1), 
              seq(max(BXData_long_mol.matrix)/paletteLength, max(BXData_long_mol.matrix), length.out=floor(paletteLength/2)))
heatmapMBOAFig.3 <- pheatmap(BXData_long_mol.matrix, color=myColor, cellwidth = 10, breaks=myBreaks, cutree_rows = 15, fontsize = 8, cluster_cols = FALSE, cluster_rows = TRUE, annotation_row = BXStrainGenusinfo_fam2, annotation_colors = colsFamily_2, main = "MBOA")

# ggsave(plot = heatmapMBOAFig.3, filename = "heatmapMBOAFig.3.pdf", width = 10, height = 18, dpi = 300, scale = 1, units = "cm")

# ggsave(plot = heatmapMBOAFig.3, filename = "heatmapMBOAFig.3.svg", width = 10, height = 18, dpi = 300, scale = 1, units = "cm")
```

```{r, warning=F, echo=F, message=F}
BXData_DG_long_5cpd <- BXData_all %>% filter(Strain != "T0") %>% 
  filter(Strain != "Standard") %>% 
  filter(Treatment %in% "DG") %>% 
  filter(Compound_name %in% c("DIMBOA-Glc", "DIM2BOA-Glc", "HMBOA-Glc", "DIMBOA", "HMBOA", "MBOA", "AMPO", "AAMPO")) %>% 
  filter(Name != "20191210_LT_LMI1_MBOA_02") %>% 
  filter(Name != "20191210_LT_LMI1_MBOA") %>% 
  filter(Name != "20191211_LT_LMI1_MBOA") %>% 
  filter(Name != "20191210_LT_NBC_DG") %>%  
  dplyr::select(Strain, Compound_name, uMol) %>%  
  distinct %>% tidyr::spread(Compound_name, uMol) %>% 
                  column_to_rownames("Strain")

BXData_DG_5cpd.matrix <- as.matrix(BXData_DG_long_5cpd)
BXData_DG_5cpd.matrix[is.na(BXData_DG_5cpd.matrix)] = 0

# Change colum order
BXcols_5cpd <- c("DIMBOA-Glc", "DIM2BOA-Glc", "HMBOA-Glc", "DIMBOA", "HMBOA", "MBOA", "AMPO", "AAMPO")

BXData_DG_5cpd.matrix <- BXData_DG_5cpd.matrix[, BXcols_5cpd]

myBreaks <- c(seq(0, 0.000178634, length.out=ceiling(paletteLength/2) + 1), 
              seq(max(BXData_DG_5cpd.matrix)/paletteLength, max(BXData_DG_5cpd.matrix), length.out=floor(paletteLength/2)))
heatmapDMGFig.3 <- pheatmap(BXData_DG_5cpd.matrix, color=myColor, cellwidth = 10, breaks=myBreaks, cutree_rows = 15, fontsize = 8, cluster_cols = FALSE, cluster_rows = TRUE, annotation_row = BXStrainGenusinfo_fam2, annotation_colors = colsFamily_2, main = "DIMBOA-Glc")

# ggsave(plot = heatmapDMGFig.3, filename = "heatmapDMGFig.3.pdf", width = 12, height = 18, dpi = 300, scale = 1, units = "cm")

# ggsave(plot = heatmapDMGFig.3, filename = "heatmapDMGFig.3.svg", width = 12, height = 18, dpi = 300, scale = 1, units = "cm")
```

```{r, warning=F, echo=F, message=F}
BXData_DIMBOA_long <- BXData_all %>% filter(Strain != "T0") %>% filter(Strain != "Standard") %>%  filter(Treatment %in% "DIMBOA") %>% filter(Name != "20191210_LT_LMI1_MBOA_02") %>% filter(Name != "20191210_LT_LMI1_MBOA") %>% filter(Name != "20191211_LT_LMI1_MBOA") %>% filter(Name != "20191210_LT_NBC_DIMBOA") %>% dplyr::select(Strain, Compound_name, uMol) %>%  distinct %>% tidyr::spread(Compound_name, uMol) %>% 
                  column_to_rownames("Strain")

BXData_DIMBOA.matrix <- as.matrix(BXData_DIMBOA_long)
BXData_DIMBOA.matrix[is.na(BXData_DIMBOA.matrix)] = 0

# Change colum order
BXcols <- c("HDMBOA-Glc", "HDM2BOA-Glc", "DIMBOA-Glc", "DIM2BOA-Glc", "HMBOA-Glc", "HM2BOA-Glc", "DIMBOA", "HMBOA", "MBOA", "AMPO", "AAMPO", "BOA", "APO", "AAPO")
BXData_DIMBOA.matrix <- BXData_DIMBOA.matrix[, BXcols]

myBreaks <- c(seq(0, 0.000178634, length.out=ceiling(paletteLength/2) + 1), 
              seq(max(BXData_DIMBOA.matrix)/paletteLength, max(BXData_DIMBOA.matrix), length.out=floor(paletteLength/2)))
pheatmap(BXData_DIMBOA.matrix, color=myColor, breaks=myBreaks, cutree_rows = 15, fontsize = 8, cluster_cols = FALSE, cluster_rows = TRUE, annotation_row = BXStrainGenusinfo_fam2, annotation_colors = colsFamily_2, main = "DIMBOA")
```

```{r, warning=F, echo=F, message=F}
BXData_DG_long_MBOA <- BXData_all %>% filter(Strain != "T0") %>% 
  filter(Strain != "Standard") %>% 
  filter(Treatment %in% "DG") %>% 
  filter(Compound_name %in% c("DIMBOA-Glc", "MBOA")) %>% 
  filter(Name != "20191210_LT_LMI1_MBOA_02") %>% 
  filter(Name != "20191210_LT_LMI1_MBOA") %>% 
  filter(Name != "20191211_LT_LMI1_MBOA") %>% 
  filter(Name != "20191210_LT_NBC_DG") %>%  
  dplyr::select(Strain, Compound_name, uMol) %>%  
  distinct %>% tidyr::spread(Compound_name, uMol) %>% 
                  column_to_rownames("Strain")

BXData_DG_MBOA.matrix <- as.matrix(BXData_DG_long_MBOA)
BXData_DG_MBOA.matrix[is.na(BXData_DG_MBOA.matrix)] = 0

# Change colum order
BXcols_MBOA <- c("DIMBOA-Glc", "MBOA")

BXData_DG_MBOA.matrix <- BXData_DG_MBOA.matrix[, BXcols_MBOA]

myBreaks <- c(seq(0, 0.000178634, length.out=ceiling(paletteLength/2) + 1), 
              seq(max(BXData_DG_MBOA.matrix)/paletteLength, max(BXData_DG_MBOA.matrix), length.out=floor(paletteLength/2)))
pheatmap(BXData_DG_MBOA.matrix, color=myColor, breaks=myBreaks, cutree_rows = 15, fontsize = 8, cluster_cols = FALSE, cluster_rows = TRUE, annotation_row = BXStrainGenusinfo_fam2, annotation_colors = colsFamily_2, main = "DIMBOA-Glc")
```

```{r, warning=F, echo=F, message=F}
BXData_all$Treat_Compound_name <- as.factor(paste(BXData_all$Treatment, BXData_all$Compound_name, sep="_") )
# levels(BXData_all$Treat_Compound_name)

BXData_all_long <- BXData_all %>% 
  filter(Strain != "T0") %>%
  filter(Strain != "Standard") %>% 
  filter(Name != "20191210_LT_LMI1_MBOA_02") %>% 
  filter(Name != "20191210_LT_LMI1_MBOA") %>% 
  filter(Name != "20191211_LT_LMI1_MBOA") %>% 
  filter(Treat_Compound_name %in% c("MBOA_MBOA", "MBOA_AMPO", "MBOA_AAMPO",
               "DG_DIMBOA-Glc", "DG_DIM2BOA-Glc", "DG_DIMBOA",  "DG_HDM2BOA-Glc",  "DG_HMBOA-Glc", "DG_HMBOA", "DG_MBOA", "DG_AMPO", "DG_AAMPO")) %>% 
  dplyr::select(Strain, Treat_Compound_name, uMol) %>%  
  distinct %>% tidyr::spread(Treat_Compound_name, uMol) %>% 
  column_to_rownames("Strain") 

BXData_all_long.matrix <- as.matrix(BXData_all_long)
BXData_all_long.matrix[is.na(BXData_all_long.matrix)] = 0

# Change col order
BXcolsall <- c("MBOA_MBOA", "MBOA_AMPO", "MBOA_AAMPO",
               "DG_DIMBOA-Glc", "DG_DIM2BOA-Glc", "DG_DIMBOA",  "DG_HDM2BOA-Glc",  "DG_HMBOA-Glc", "DG_HMBOA", "DG_MBOA", "DG_AMPO", "DG_AAMPO")

BXData_all_long.matrix <- BXData_all_long.matrix[, BXcolsall]

paletteLength <- 300
myColor <- colorRampPalette(colsBlue)(paletteLength)
# length(breaks) == length(paletteLength) + 1
# use floor and ceiling to deal with even/odd length pallettelengths
myBreaks <- c(seq(0, 0.000178634, length.out=ceiling(paletteLength/2) + 1), 
              seq(max(BXData_all_long.matrix)/paletteLength, max(BXData_all_long.matrix), length.out=floor(paletteLength/2)))
pheatmap(BXData_all_long.matrix, color=myColor, breaks=myBreaks, cutree_rows = 8, gaps_col = 3, fontsize = 8, cluster_cols = FALSE, cluster_rows = TRUE, annotation_row = BXStrainGenusinfo_fam2, annotation_colors = colsFamily_2)
```

```{r, warning=F, echo=F, message=F}
BXData_Ctrl_long <- BXData_all %>% filter(Name != "20191210_LT_NBC_Ctrl") %>% filter(Strain != "T0") %>% filter(Strain != "Standard") %>%  filter(Treatment %in% "Ctrl") %>% filter(Name != "20191210_LT_LMI1_MBOA_02") %>% filter(Name != "20191210_LT_LMI1_MBOA") %>% filter(Name != "20191211_LT_LMI1_MBOA") %>%  dplyr::select(Strain, Compound_name, uMol) %>%  distinct %>% tidyr::spread(Compound_name, uMol) %>% 
                  column_to_rownames("Strain")

BXData_Ctrl.matrix <- as.matrix(BXData_Ctrl_long)
BXData_Ctrl.matrix[is.na(BXData_Ctrl.matrix)] = 0

# Change col order
BXcols <- c("HDMBOA-Glc", "HDM2BOA-Glc", "DIMBOA-Glc", "DIM2BOA-Glc", "HMBOA-Glc", "HM2BOA-Glc", "DIMBOA", "HMBOA", "MBOA", "AMPO", "AAMPO", "BOA", "APO", "AAPO")
BXData_Ctrl.matrix <- BXData_Ctrl.matrix[, BXcols]

myBreaks <- c(seq(0, 0.000000000000000000000000000000000000000000000178634, length.out=ceiling(paletteLength/2) + 1), 
              seq(max(BXData_Ctrl.matrix)/paletteLength, max(BXData_Ctrl.matrix), length.out=floor(paletteLength/2)))
pheatmap(BXData_Ctrl.matrix, color=myColor, cutree_rows = 15, fontsize = 8, cluster_cols = FALSE, cluster_rows = TRUE, annotation_row = BXStrainGenusinfo, annotation_colors = colsFamily_2, main = "Control")
```

# Fraction compound metabolized
As MBOA and DIMBOA are quite stable in the growth conditions in liquid cultures, the fraction of metabolized compound can be easily calculated for each strain. 
The value for the certain compound (uMol) in a certain strain is substracted from the NBC treatment & divided by the NBC treatment value and multiplyied by 100 to get percentage.

```{r, warning=F, echo=F, message=F}
# MBOA
BXData_MBOA <- BXData %>%  filter(Compound_name %in% "MBOA")
BXData_MBOA$fraction_met_MBOA <- ((MBOA_NBC$uMol - BXData_MBOA$uMol) / MBOA_NBC$uMol) * 100

# DIMBOA-Glc
BXData_DG_met <- BXData_DG %>% filter(Compound_name %in% "DIMBOA-Glc")
BXData_DG_met$fraction_met_DG <- ((DIMBOAGlc_NBC$uMol - BXData_DG_met$uMol) / DIMBOAGlc_NBC$uMol) * 100

# merge genus & strain information
BXData_DG_met$Genus_Strain <- as.factor(paste(BXData_DG_met$Genus, BXData_DG_met$Strain, sep="_") )
```

```{r, warning=F, echo=F, message=F}
BXData_DG_met <- BXData_DG_met %>% dplyr::select(Strain, Genus, Phylum, Class, Order, Family, Name, Compound_name, ng.mL_adj, uMol, Genus_Strain, fraction_met_DG)

BXData_met <- left_join(BXData_DG_met, BXData_MBOA %>% dplyr::select(Strain, fraction_met_MBOA), by = "Strain")
```

```{r, warning=F, echo=F, message=F}
BXData_met %>% filter(Strain != "T0") %>% filter(Strain != "NBC") %>%
  ggplot(aes(y = fraction_met_MBOA, x = Genus_Strain)) +
  geom_bar(aes(fill = fraction_met_MBOA), position = "dodge", stat = "summary", fun.y ="mean", show.legend = FALSE) +
  theme_bw() +
  theme(axis.text.x=element_text(angle = -90, hjust = 0, vjust = 0.5 )) +
  scale_fill_viridis_c(option="viridis") +
  labs(x = "Strain",
       y = "% metabolized MBOA",
       title = "Fraction metabolized MBOA",
       subtitle = "after 60h",
       color = "Strain")
```

```{r, warning=F, echo=F, message=F}
BXData_DG_met %>% filter(Strain != "T0") %>% filter(Strain != "NBC") %>%
  # mutate(Hours = as.factor(Hours)) %>%
  ggplot(aes(y = fraction_met_DG, x = Genus_Strain)) +
  geom_bar(aes(fill = fraction_met_DG), position = "dodge", stat = "summary", fun.y ="mean", show.legend = FALSE) +
  theme_bw() +
  theme(axis.text.x=element_text(angle = -90, hjust = 0, vjust = 0.5 )) +
  scale_fill_viridis_c(option="viridis") +
  # theme(axis.text.y = element_blank(), text = element_text(size=14)) +
  # guides(fill = guide_colourbar("Maximal\nOD 600")) +
  labs(x = "Strain",
       y = "% metabolized MBOA",
       title = "Fraction metabolized MBOA",
       subtitle = "after 60h",
       color = "Strain")
```

# Qualitative analysis
Since there is quite some variation in the absolute values of metabolites in the cultures, which makes it difficult to categorize the bacteria to metabolic types, we to qualitative categorization of the bacteria to groups. We define threshold concentrations of the supplemented compounds (MBOA & DIMBOA-Glc) to group bacteria into "degraders" or "non-degraders" and for metabolization products (AMPO & AAMPO) to group in "formers" and "non-formers". 

```{r, warning=F, echo=F, message=F}
# All strains
BXData_all %<>% filter(!Strain %in% c("Standard", "T0"))
All <- BXData_all$Strain %>% unique()
```

**MBOA degradation**
We define MBOA degradation with a threshold of 70 % MBOA compared to NBC detected (587.5834 μM). This corresponds to 411.3084 and we set the threshold to 400 μM.

```{r, warning=F, echo=F, message=F, include=F}
# MBOA_no
MBOA <- BXData_all %>% filter(Treatment %in% "MBOA") %>% filter(Compound_name %in% "MBOA") %>% select(Strain, uMol) %>% unique() %>% na.omit()

## to define a threshold for MBOA metabolization
MBOA %<>% dplyr::arrange(desc(uMol))

MBOA$uMol %>% max()
MBOA$uMol %>% min()

MBOA_NBC_uMol <- BXData_all %>%
  filter(Strain != "T0") %>% 
  filter(Compound_name %in% "MBOA") %>% 
  filter(Treatment %in% "MBOA") %>% 
  filter(Strain %in% "NBC") %>% 
  dplyr::select(Strain, Compound_name, uMol) %>% 
  arrange(desc(uMol)) %>% 
  select(uMol)

# 587.5834
MBOA %>% filter(Strain %in% "LMI1x") 
MBOA %>% filter(Strain %in% "LME3") 
# 484.9273

# Calculate threshold: 70% of NBC
MBOA_met_threshold_weak <- (MBOA_NBC_uMol$uMol / 100) * 70
# MBOA_met_threshold <- "400"
# 411.3084

MBOA_met_threshold_strong <- (MBOA_NBC_uMol$uMol / 100) * 10

MBOA_met_1per <- (MBOA_NBC_uMol$uMol / 100) * 1
# MBOA_met_threshold <- "400"
# 411.3084

# MBOA_no <- BXData_all %>% filter(Treatment %in% "MBOA") %>% filter(Compound_name %in% "MBOA", uMol > 411.3084) %>% select(Strain, uMol) %>% unique()

MBOA_no <- BXData_all %>% filter(Treatment %in% "MBOA") %>% filter(Strain != "NBC") %>% filter(Compound_name %in% "MBOA", uMol > MBOA_met_threshold_weak) %>% select(Strain, uMol) %>% unique() 

MBOA_no <- MBOA_no$Strain
MBOA_no %>% pander()
MBOA_no_count <- MBOA_no %>% length()

# MBOA_deg
MBOA_deg <- BXData_all %>% filter(Treatment %in% "MBOA") %>% filter(Compound_name %in% "MBOA", uMol < MBOA_met_threshold_weak) %>% select(Strain, uMol) %>% unique() 

MBOA_deg <- MBOA_deg$Strain
MBOA_deg %>% pander()
MBOA_deg_count <- MBOA_deg %>% length()
```

**AMPO formation**
> 0.13 μM

*Weak AMPO formation:* To define the threshold for AMPO formation, we check the amount of AMPO produced by the Rhizobia which show a weak colour change in the plate assay, consistently form little AMPO, and degrades MBOA. 
0.13 μM - 10 μM

*Strong AMPO formation:* To define the threshold for strong AMPO formation, we check the amount of AMPO formed by Pseudoarthrobacter which consistently shows an intensive red colour on the plate assay, red precipitation in liquid medium and degrades MBOA.
> 10 μM

```{r, warning=F, echo=F, message=F, include=F}
# MBOA_AMPO
## Weak AMPO formation
BXData_all %>% filter(Treatment %in% "MBOA") %>% filter(Compound_name %in% "AMPO") %>% dplyr::select(Strain, uMol) #%>% filter(Strain %in% c("LRH13", "LRC7.O", "LRH8.O")) 


## Strong AMPO formation
BXData_all %>% filter(Treatment %in% "MBOA") %>% filter(Compound_name %in% "AMPO") %>% filter(Strain %in% c("LMD1")) %>% dplyr::select(Strain, uMol)

# All AMPO formers
MBOA_AMPO <- BXData_all %>% filter(Treatment %in% "MBOA") %>% filter(Compound_name %in% "AMPO", uMol > 0.13) %>% dplyr::select(Strain, uMol) %>% na.omit() %>% unique() %>% as.data.frame()
MBOA_AMPO <- MBOA_AMPO$Strain
MBOA_AMPO %>% pander()

met_AMPO_from_MBOA_max <- BXData_all %>% filter(Treatment %in% "MBOA") %>% 
                                         filter(Compound_name %in% c("AMPO")) %>%  
                                         filter(!uMol %in% NA) %>%  
                                         dplyr::summarize(conc_max = max(uMol))

AMPO_from_MBOA_strong <- met_AMPO_from_MBOA_max$conc_max / 100 * 10
# 4.249294

AMPO_from_MBOA_weak <- met_AMPO_from_MBOA_max$conc_max / 100 * 0.1
# 0.04249294



# MBOA_AMPO <- MBOA_AMPO$Strain
# MBOA_AMPO %>% pander()

# Strong AMPO formers
MBOA_AMPO_strong <- BXData_all %>% filter(Treatment %in% "MBOA") %>% filter(Compound_name %in% "AMPO", uMol > 10) %>% dplyr::select(Strain, uMol) %>% na.omit() %>% unique() %>% as.data.frame()

MBOA_AMPO_strong <- MBOA_AMPO_strong$Strain
MBOA_AMPO_strong %>% pander()
```

**AAMPO formation**
Same as for AMPO
> 0.13 μM

```{r, warning=F, echo=F, message=F, include=F}
MBOA_AAMPO <- BXData_all %>% filter(Treatment %in% "MBOA") %>% filter(Compound_name %in% "AAMPO", uMol > 0.13) %>% dplyr::select(Strain, uMol) %>% na.omit() %>% unique() %>% as.data.frame()

MBOA_AAMPO <- MBOA_AAMPO$Strain
MBOA_AAMPO %>% pander()
```


**DIMBOA-Glc degradation**
We define DIMBOA-Glc degradation with a threshold of 70 % DIMBOA-Glc compared to NBC detected (246.9373 μM). This value is much lower compared to MBOA because the DIMBOA-Glc we used was only of 70% purity. This corresponds to 172.8561 and we set the threshold to 170 μM.

```{r, warning=F, echo=F, message=F, include=F}
# DIMBOA
DIMBOA <- BXData_all %>% filter(Treatment %in% "DIMBOA") %>% filter(Compound_name %in% "DIMBOA") %>% select(Strain, uMol) %>% unique() 

# DIMBOA_AMPO
DIMBOA_AMPO <- BXData_all %>% filter(Treatment %in% "DIMBOA") %>% filter(Compound_name %in% "AMPO", uMol > 0.13) %>% dplyr::select(Strain, uMol) %>% na.omit() %>% unique() %>% as.data.frame()

DIMBOA_AMPO <- DIMBOA_AMPO$Strain
DIMBOA_AMPO %>% pander()

# DIMBOA_AAMPO
DIMBOA_AMPO <- BXData_all %>% filter(Treatment %in% "DIMBOA") %>% filter(Compound_name %in% "AAMPO", uMol > 0.13) %>% dplyr::select(Strain, uMol) %>% na.omit() %>% unique() %>% as.data.frame()

DIMBOA_AAMPO <- DIMBOA_AMPO$Strain
DIMBOA_AAMPO %>% pander()

# DIMBOA_MBOA
DIMBOA_MBOA <- BXData_all %>% filter(Treatment %in% "DIMBOA") %>% filter(Compound_name %in% "MBOA", uMol > 0) %>%  dplyr::select(Strain, uMol) %>% unique() %>% as.data.frame()

DIMBOA_MBOA <- DIMBOA_MBOA$Strain
DIMBOA_MBOA %>% pander

# DIMBOA_stab
DIMBOA_stab <- BXData_all %>% filter(Treatment %in% "DIMBOA") %>% filter(Compound_name %in% "DIMBOA", uMol > 0) %>% select(Strain, uMol) %>% unique() 

DIMBOA_stab <- DIMBOA_stab$Strain
DIMBOA_stab %>% pander()

# DIMBOA-Glucose
DG <- BXData_all %>% filter(Treatment %in% "DG") %>% filter(Compound_name %in% "DIMBOA-Glc") %>% select(Strain, uMol) %>% unique() 

## to define a threshold for MBOA metabolization
DG %<>% dplyr::arrange(desc(uMol))

DG$uMol %>% max()
DG$uMol %>% min()

DG %>% filter(Strain %in% "LME3") 
# 0
DG %>% filter(Strain %in% "NBC")
# 246.9373

DG_NBC_uMol <- BXData_all %>%
  filter(Strain != "T0") %>% 
  filter(Compound_name %in% "DIMBOA-Glc") %>% 
  filter(Treatment %in% "DG") %>% 
  filter(Strain %in% "NBC") %>% 
  dplyr::select(Strain, Compound_name, uMol) %>% 
  arrange(desc(uMol)) %>% 
  select(uMol)


BXData_all %>%
  filter(Strain != "T0") %>% 
  filter(Compound_name %in% "DIMBOA-Glc") %>% 
  filter(Treatment %in% "DG") %>% 
  filter(Strain %in% "LPD2") %>% 
  dplyr::select(Strain, Compound_name, uMol) %>% 
  arrange(desc(uMol)) %>% 
  select(uMol)


DG_AMPO <- BXData_all %>% filter(Treatment %in% "DG") %>% filter(Compound_name %in% "AMPO", uMol > 0) %>% dplyr::select(Strain, uMol) %>% unique() %>% as.data.frame()
DG_AMPO <- DG_AMPO$Strain

met_AMPO_from_DMG_max <- BXData_all %>% filter(Treatment %in% "DG") %>% 
                                         filter(Compound_name %in% c("AMPO")) %>%  
                                         filter(!uMol %in% NA) %>%  
                                         dplyr::summarize(conc_max = max(uMol))

AMPO_from_DMG_strong <- met_AMPO_from_MBOA_max$conc_max / 100 * 10
# 4.249294

AMPO_from_DMG_weak <- met_AMPO_from_MBOA_max$conc_max / 100 * 0.1
# 0.04249294


DG_AAMPO <- BXData_all %>% filter(Treatment %in% "DG") %>% filter(Compound_name %in% "AAMPO", uMol > 0.1) %>% dplyr::select(Strain, uMol) %>% unique() %>% as.data.frame()
DG_AAMPO <- DG_AAMPO$Strain


# Calculate threshold: 85% of NBC
## new: 70% of NBC
DG_NBC_uMol$uMol - ((DG$uMol %>% max()) - DG_NBC_uMol$uMol)
# 176.9457

DMG_met_threshold_weak <- (DG_NBC_uMol$uMol / 100) * 70
# 172.8561
# DMG_met_threshold <- 170

DMG_met_threshold_strong <- (DG_NBC_uMol$uMol / 100) * 10

# DG_no <- BXData_all %>% filter(Treatment %in% "DG") %>% filter(Compound_name %in% "DIMBOA-Glc", uMol > 209.89) %>% select(Strain, uMol) %>% unique()

DG_no <- BXData_all %>% filter(Treatment %in% "DG") %>% filter(Strain != "NBC") %>% filter(Compound_name %in% "DIMBOA-Glc", uMol > DMG_met_threshold_weak) %>% select(Strain, uMol) %>% unique()
DG_no <- DG_no$Strain
DG_no %>% length()

# DG_deg <- BXData_all %>% filter(Treatment %in% "DG") %>% filter(Compound_name %in% "DIMBOA-Glc", uMol < 209.89) %>% select(Strain, uMol) %>% unique()
DG_deg <- BXData_all %>% filter(Treatment %in% "DG") %>% filter(Compound_name %in% "DIMBOA-Glc", uMol < DMG_met_threshold_weak) %>% select(Strain, uMol) %>% unique()
DG_deg <- DG_deg$Strain
```

*MBOA formation from DIMBOA-Glc*

We define MBOA formation from DIMBOA-Glc with a threshold of 10 % MBOA compared to the maximum of MBOA detected in DIMBOA-Glc treated samples (143.2905 μM). We set the threshold to 14 μM.

```{r, warning=F, echo=F, message=F, include=F}
DG_deg %>% length()

# Calculate threshold: max MBOA production in DMG medium
DG_MBOA_min_uMol <- BXData_all %>%
  # filter(Strain != "LST14") %>% 
  filter(Compound_name %in% "MBOA") %>% 
  filter(Treatment %in% "DG") %>% 
  #filter(Strain %in% "LRH8.S") %>% 
  dplyr::select(Strain, Compound_name, uMol) %>% 
  arrange(desc(uMol)) %>% 
  select(uMol)

DG_MBOA_max <- DG_MBOA_min_uMol$uMol %>% max()

#  10 % of max value = 14.32905
DG_MBOA_values <- BXData_all %>% filter(Treatment %in% "DG") %>% filter(Compound_name %in% "MBOA") %>% select(Strain, uMol) %>% unique() %>% na.omit() %>% arrange(desc(uMol))

DMG_MBOA_met_threshold <- DG_MBOA_max / 100 * 10

DG_MBOA <- BXData_all %>% filter(Treatment %in% "DG") %>% filter(Compound_name %in% "MBOA", uMol > DMG_MBOA_met_threshold) %>% select(Strain, uMol) %>% unique() %>% na.omit() 
DG_MBOA <- DG_MBOA$Strain


met_MBOA_from_DMG_max <- BXData_all %>% filter(Treatment %in% "DG") %>% 
                                         filter(Compound_name %in% c("MBOA")) %>%  
                                         filter(!uMol %in% NA) %>%  
                                         dplyr::summarize(conc_max = max(uMol))

MBOA_from_DMG_strong <- met_MBOA_from_DMG_max$conc_max / 100 * 10
# 14.32905

MBOA_from_DMG_weak <- met_MBOA_from_DMG_max$conc_max / 100 * 0.1
# 0.1432905
```


```{r, warning=F, echo=F, message=F, include=F}
# Overview
MBOA_AMPO 
MBOA_AMPO_count <- MBOA_AMPO %>% length()

MBOA_AAMPO
MBOA_AAMPO_count <- MBOA_AAMPO %>% length()

MBOA_no
MBOA_no_count <- MBOA_no %>% length()

MBOA_deg
MBOA_deg_count <- MBOA_deg %>% length()

DG_AMPO 
DG_AMPO_count <- DG_AMPO %>% length()

DG_AAMPO
DG_AAMPO_count <- DG_AAMPO %>% length()

DG_no
DG_no_count <- DG_no %>% length()

DG_deg
DG_deg_count <- DG_deg %>% length()

DG_MBOA
DG_MBOA_count <- DG_MBOA %>% length()
```



## Qualitative Graphs
```{r, warning=F, echo=F, message=F}
# Prepare data
# make long
BXData_long_mol <- BXData %>% filter(Strain != "T0") %>% 
  filter(Strain != "Standard") %>%  
  filter(Treatment %in% "MBOA") %>% 
  filter(Name != "20191210_LT_LMI1_MBOA_02") %>% 
  filter(Name != "20191211_LT_LMI1_MBOA") %>%  
  filter(Name != "20191210_LT_NBC_MBOA") %>%
  filter(Treatment %in% "MBOA") %>% 
  filter(Compound_name %in% c("MBOA", "AMPO", "AAMPO")) %>% 
  mutate(Genus = gsub( "Acinetobacter", "Moraxellaceae",Genus)) %>% 
  arrange(desc(Family)) %>% 
  mutate(Genus_Strain = gsub("NA_NBC", "_NBC", Genus_Strain)) %>%  
  dplyr::select(Genus_Strain, Compound_name, uMol) %>%  
  unique() %>% 
  tidyr::spread(Compound_name, uMol) %>% 
  column_to_rownames("Genus_Strain")

BXData_long_mol.matrix <- as.matrix(BXData_long_mol)
BXData_long_mol.matrix[is.na(BXData_long_mol.matrix)] = 0

# Change colum order
BXcols <- c("MBOA", "AMPO", "AAMPO")

BXData_long_mol.matrix <- BXData_long_mol.matrix[, BXcols]

#replace values with value with binaries
#used to be 0-5, 5-400 and 400-700
#used to be 0-0.13, 0.13-10, 10-100

BXData_long_mol.matrix[, 1][BXData_long_mol.matrix[, 1]>=0 & BXData_long_mol.matrix[, 1]<=MBOA_met_threshold_strong] <- 0 # no MBOA detected
BXData_long_mol.matrix[, 1][BXData_long_mol.matrix[, 1]>=MBOA_met_threshold_strong & BXData_long_mol.matrix[, 1]<=MBOA_met_threshold_weak] <- 1 # MBOA degraded
BXData_long_mol.matrix[, 1][BXData_long_mol.matrix[, 1]>=MBOA_met_threshold_weak & BXData_long_mol.matrix[, 1]<=700] <- 2 # MBOA not degraded

BXData_long_mol.matrix[, 2][BXData_long_mol.matrix[, 2]>=0 & BXData_long_mol.matrix[, 2]<=AMPO_from_MBOA_weak] <- 0 # no AMPO detected
BXData_long_mol.matrix[, 2][BXData_long_mol.matrix[, 2]>=AMPO_from_MBOA_weak & BXData_long_mol.matrix[, 2]<=AMPO_from_MBOA_strong] <- 3 # weak AMPO
BXData_long_mol.matrix[, 2][BXData_long_mol.matrix[, 2]>=AMPO_from_MBOA_strong & BXData_long_mol.matrix[, 2]<=100] <- 4 # strong AMPO

BXData_long_mol.matrix[, 3][BXData_long_mol.matrix[, 3]>=0 & BXData_long_mol.matrix[, 3]<=AMPO_from_MBOA_weak] <- 0 # no AAMPO detected
BXData_long_mol.matrix[, 3][BXData_long_mol.matrix[, 3]>=AMPO_from_MBOA_weak & BXData_long_mol.matrix[, 3]<=AMPO_from_MBOA_strong] <- 3 # weak AAMPO
BXData_long_mol.matrix[, 3][BXData_long_mol.matrix[, 3]>=AMPO_from_MBOA_strong & BXData_long_mol.matrix[, 3]<=100] <- 4 # strong AAMPO

heatmapMBOAFig.3_binary <- pheatmap(BXData_long_mol.matrix, 
                             color = c("white", "#555CCB", "darkblue", "tomato1", "darkred"),
                             cellwidth = 10, 
                             cutree_rows = 6, 
                             fontsize = 8, 
                             cluster_cols = FALSE, 
                             cluster_rows = FALSE, 
                             main = "MBOA")

# ggsave(plot = heatmapMBOAFig.3_binary, filename = "heatmapMBOAFig.3_binary.pdf", width = 10, height = 18, dpi = 300, scale = 1, units = "cm")
# # 
# ggsave(plot = heatmapMBOAFig.3_binary,  filename = "heatmapMBOAFig.3_binary.svg", width = 10, height = 18, dpi = 300, scale = 1, units = "cm")
```

```{r, warning=F, echo=F, message=F}
BXData_all_phylo <- left_join(BXData_all, BXData %>% dplyr::select(Strain, Genus_Strain, Family, Phylum) %>% unique(), by = "Strain")

BXData_DG_long_5cpd <- BXData_all_phylo %>% filter(Strain != "T0") %>% 
  filter(Strain != "Standard") %>% 
  filter(Treatment %in% "DG") %>% 
  filter(Compound_name %in% c("DIMBOA-Glc", "DIM2BOA-Glc", "HMBOA-Glc", "DIMBOA", "HMBOA", "MBOA", "AMPO", "AAMPO")) %>% 
  filter(Name != "20191210_LT_LMI1_MBOA_02") %>% 
  filter(Name != "20191210_LT_LMI1_MBOA") %>% 
  filter(Name != "20191211_LT_LMI1_MBOA") %>% 
  filter(Name != "20191210_LT_NBC_DG") %>%  
  arrange(desc(Family)) %>% 
  mutate(Genus_Strain = gsub("NA_NBC", "_NBC", Genus_Strain)) %>%  
  dplyr::select(Genus_Strain, Compound_name, uMol) %>%  
  unique() %>% 
  tidyr::spread(Compound_name, uMol) %>% 
  column_to_rownames("Genus_Strain")

BXData_DG_5cpd.matrix <- as.matrix(BXData_DG_long_5cpd)
BXData_DG_5cpd.matrix[is.na(BXData_DG_5cpd.matrix)] = 0

# Change colum order
BXcols_5cpd <- c("DIMBOA-Glc", "MBOA", "AMPO", "AAMPO")

BXData_DG_5cpd.matrix <- BXData_DG_5cpd.matrix[, BXcols_5cpd]

# [, 1] DIMBOA-Glc
# [, 1] DIMBOA
# [, 1] MBOA
# [, 1] AMPO
# [, 1] AAMPO

#replace values with value with binaries
# change values - HERE STOPPPED!!!!!!!!!
BXData_DG_5cpd.matrix[, 1][BXData_DG_5cpd.matrix[, 1]>=0 & BXData_DG_5cpd.matrix[, 1]<=DMG_met_threshold_strong] <- 0 # no DIMBOA-Glc detected
BXData_DG_5cpd.matrix[, 1][BXData_DG_5cpd.matrix[, 1]>=DMG_met_threshold_strong & BXData_DG_5cpd.matrix[, 1]<=DMG_met_threshold_weak] <- 5 # DIMBOA-Glc degraded
BXData_DG_5cpd.matrix[, 1][BXData_DG_5cpd.matrix[, 1]>=DMG_met_threshold_weak & BXData_DG_5cpd.matrix[, 1]<=700] <- 6 # DIMBOA-Glc not degraded

BXData_DG_5cpd.matrix[, 2][BXData_DG_5cpd.matrix[, 2]>=0 & BXData_DG_5cpd.matrix[, 2]<=MBOA_from_DMG_weak] <- 0 # no MBOA detected
BXData_DG_5cpd.matrix[, 2][BXData_DG_5cpd.matrix[, 2]>=MBOA_from_DMG_weak & BXData_DG_5cpd.matrix[, 2]<=MBOA_from_DMG_strong] <- 1 # weak MBOA
BXData_DG_5cpd.matrix[, 2][BXData_DG_5cpd.matrix[, 2]>=MBOA_from_DMG_strong & BXData_DG_5cpd.matrix[, 2]<=500] <- 2 # strong MBOA

BXData_DG_5cpd.matrix[, 3][BXData_DG_5cpd.matrix[, 3]>=0 & BXData_DG_5cpd.matrix[, 3]<=AMPO_from_MBOA_weak] <- 0 # no AMPO detected
BXData_DG_5cpd.matrix[, 3][BXData_DG_5cpd.matrix[, 3]>=AMPO_from_MBOA_weak & BXData_DG_5cpd.matrix[, 3]<=AMPO_from_MBOA_strong] <- 3 # weak AMPO
BXData_DG_5cpd.matrix[, 3][BXData_DG_5cpd.matrix[, 3]>=AMPO_from_MBOA_strong & BXData_DG_5cpd.matrix[, 3]<=100] <- 4 # strong AMPO

BXData_DG_5cpd.matrix[, 4][BXData_DG_5cpd.matrix[, 4]>=0 & BXData_DG_5cpd.matrix[, 4]<=AMPO_from_MBOA_weak] <- 0 # no AAMPO detected
BXData_DG_5cpd.matrix[, 4][BXData_DG_5cpd.matrix[, 4]>=AMPO_from_MBOA_weak & BXData_DG_5cpd.matrix[, 4]<=AMPO_from_MBOA_strong] <- 3 # weak AAMPO
BXData_DG_5cpd.matrix[, 4][BXData_DG_5cpd.matrix[, 4]>=AMPO_from_MBOA_strong & BXData_DG_5cpd.matrix[, 4]<=100] <- 4 # strong AAMPO

heatmapDIMBOAGlcFig.3_binary <- pheatmap(BXData_DG_5cpd.matrix, 
                             color = c("white", "#555CCB", "darkblue", "tomato1", "darkred",  "orange", "darkorange2"),
                             cellwidth = 10, 
                             cutree_rows = 8, 
                             fontsize = 8, 
                             cluster_cols = FALSE, 
                             cluster_rows = FALSE, 
                             clustering_method = "average", 
                             main = "DIMBOA-Glc")




# ggsave(plot = heatmapDIMBOAGlcFig.3_binary,  filename = "heatmapDIMBOAGlcFig.3_binary.pdf", width = 12, height = 18, dpi = 300, scale = 1, units = "cm")
# # 
# ggsave(plot = heatmapDIMBOAGlcFig.3_binary,  filename = "heatmapDIMBOAGlcFig.3_binary.svg", width = 12, height = 18, dpi = 300, scale = 1, units = "cm")

```

# Summary table
```{r, warning=F, echo=F, message=F}
# MBOA_only_AAMPO <- setdiff(MBOA_AAMPO, MBOA_AMPO)
# MBOA_only_AMPO_count <- MBOA_only_AMPO %>% length()

MBOA_AMPO_AAMPO <- intersect(MBOA_AMPO, MBOA_AAMPO)
MBOA_AMPO_AAMPO_count <- MBOA_AMPO_AAMPO %>% length()

DG_only_AAMPO <- setdiff(DG_AAMPO, DG_MBOA)
DG_only_AAMPO_count <- DG_only_AAMPO %>% length()

DG_AMPO_AAMPO <- intersect(DG_AMPO, DG_AAMPO)
DG_AMPO_AAMPO_count <- DG_AMPO_AAMPO %>% length()
  
DG_only_AMPO <- setdiff(DG_AMPO_AAMPO, DG_MBOA)
DG_only_AMPO_count <- DG_only_AMPO %>% length()

metabolization_table <- tibble("Chem" = c("MBOA", "DMG"),
              "No_met" = c(MBOA_no_count, DG_no_count),
              "Met" = c(MBOA_deg_count, DG_deg_count),
              "MBOA" = c(NA, DG_MBOA_count), 
              "AMPO" = c(MBOA_AMPO_count, DG_AMPO_count),
              "AAMPO" = c(MBOA_AAMPO_count, DG_AAMPO_count),
              "unknown" = c(MBOA_deg_count - MBOA_AMPO_count, DG_deg_count - DG_MBOA_count - DG_only_AAMPO_count - DG_only_AMPO_count),
              "total" = c(MBOA_no_count + MBOA_deg_count, DG_no_count + DG_deg_count))



metabolization_table %>% knitr::kable()
```


## Venn Diagramms metabolism
Comparing metabolism patterns across strains with a VennDiagramm.
 
```{r, warning=F, echo=F, message=F}
# load functions
source("Input/functions/vennDia.R")
source("Input/functions/fun_venn_plot.R")
source("Input/functions/fun_venn_pair.R")
source("Input/functions/fun_venn_triple.R")
```

```{r, fig.height=8, fig.width=8, warning=F, echo=F}
#plot bacteria enriched in roots

# AMPO: darkred
# MBOA: tomato 
# DIMBOA-Glc: darkorange
# DIMBOA: orange

par(mfrow=c(2,2))
par(mar=c(0.5,0.5,2.8,0.5))

AMPOstrains <- venndiagram(MBOA_AMPO, DIMBOA_AMPO, DG_AMPO, 
                           xpd=F, printsub=F, tcol="black", diacol="black",
                           lcol=c("tomato", "orange", "darkorange"), 
                           lines=c("tomato", "orange", "darkorange"),
                           labels=c("MBOA", "DIMBOA", "DIMBOA-Glc"),
                           title="AMPO strains", cex.main=1.5)

MBOAmet <- venndiagram(MBOA_AMPO, MBOA_deg, MBOA_no, 
                           xpd=F, printsub=F, tcol="black", diacol="black",
                           lcol=c("darkred", "maroon", "darkblue"), 
                           lines=c("darkred", "maroon", "darkblue"),
                           labels=c("AMPO", "MBOA degradation", "no MBOA degradation"),
                           title="MBOA metabolism", cex.main=1.5)

DIMBOA_Glcmet <- venndiagram(DG_AMPO, DG_MBOA, DG_no,
                             xpd=F, printsub=F, tcol="black", diacol="black",
                           lcol=c("darkred", "tomato", "tan4"), 
                           lines=c("darkred", "tomato", "tan4"),
                           labels=c("AMPO", "DIMBOA-Glc to MBOA", "no DIMBOA-Glc degradation"),
                           title="DIMBOA-Glc metabolism", cex.main=1.5)

Metabolizers <- venndiagram(MBOA_deg, DIMBOA_MBOA, DG_MBOA, 
                           xpd=F, printsub=F, tcol="black", diacol="black",
                           lcol=c("maroon", "orange", "tomato"), 
                           lines=c("maroon", "orange", "tomato"),
                           labels=c("MBOA degradation", "DIMBOA to MBOA", "DIMBOA-Glc to MBOA"),
                           title="BX metabolizers", cex.main=1.5)

print(AMPOstrains)

paste(AMPOstrains$q1) 
paste(MBOAmet$q1) 
paste(DIMBOA_Glcmet$q1) 
paste(Metabolizers$q1)

# dev.off()
``` 

```{r, warning=F, echo=F, message=F}
sessionInfo()
```

