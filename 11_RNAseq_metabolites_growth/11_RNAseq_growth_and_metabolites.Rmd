---
title: "RNAseq experiment growth and metabolites"
subtitle: "Thoenen_et_al_Bacteria_BX_metabolization"
author: "Lisa ThÃ¶nen"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

Here we report the growth and metabolite data of the bacterial cultures used for the transcriptome experiment. Bacteria were grown for 16 hours in a laboratory shaker and one plate was grown in a tecan plate reader and used to analyse the growth data. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,include=FALSE}
rm(list=ls())
```

```{r,include=FALSE}
# install.packages("dplyr") 
# install.packages("magrittr") # for the %>% function
# install.packages("ggplot2") # plots
# install.packages("readxl") # to read excels
# install.packages("stringr")
# install.packages("MESS") # for auc function
# install.packages("purrr")
# install.packages("multcomp")
# install.packages("emmeans")
# install.packages("ggpubr")
# install.packages("ggpmisc")
# install.packages("ggbeeswarm")
```

```{r,include=FALSE}
library("dplyr")
library("magrittr")
library("ggplot2")
library("readxl")
library("tidyr")
library("readr")
library("stringr")
library("MESS") 
library("purrr")
library("multcomp")
library("emmeans")
library("ggpubr")
library("ggpmisc")
library("ggbeeswarm")
```

# Bacterial growth

```{r, echo=F, message=F, warning=F}
metadata <- read_excel("Input/210324_RNAseq_experimental_design.xlsx", sheet = 4)
```

```{r, echo=F, message=F, warning=F}
results <- data_frame()
results <-  read_excel("Input/21.07.21_RNAseq_experiment.xlsx", sheet = 2, range = "A38:AE133", col_names = c("Well", 1:30)) %>% as.data.frame()
results2 <-  read_excel("Input/21.07.21_RNAseq_experiment.xlsx", sheet = 1, range = "A38:FY133", col_names = c("Well", 1:180)) %>% as.data.frame()

results <- full_join(metadata, results, by = "Well")
results2 <- full_join(metadata, results2, by = "Well")

results <- results %>% gather(key = "Cycle", value = "Density", 8:ncol(.))
results2 <- results2 %>% gather(key = "Cycle", value = "Density", 8:ncol(.))

results$hrs <- as.numeric((results$Cycle))/2
results$Density <- as.numeric(results$Density)

results2$hrs <- as.numeric((results2$Cycle))/2
results2$Density <- as.numeric(results2$Density)

results %<>%  mutate(Density_increase = Density - Density[1])
results2 %<>%  mutate(Density_increase = Density - Density[1])

results_all <- rbind(results, results2)
```

Raw data growth curves 16 hours

```{r, echo=F, message=F, warning=F}
results %>% #filter(Treatment != "medium") %>%
  filter(Strain %in% c("LMB2", "NBC")) %>%
  ggplot(aes(x = hrs, y = Density_increase)) +
  # stat_summary(geom = "pointrange", fun.y = mean, fun.ymax = max, fun.ymin = min, alpha = 0.5) +
  geom_line(aes(color = Treatment, linetype = as.factor(Replicate)), stat = "summary", fun.y = mean,  show.legend = TRUE, size = 1) +
  # geom_line(aes(color = Treatment, group = Treatment, x = Cycle, y = Density), stat = "summary", fun.y = mean,
     #       show.legend = FALSE)+
  facet_grid(~Strain, scales = "fixed") +
  theme_bw() +
  scale_color_manual(values = c("cornflowerblue", "maroon")) +
  labs(y = "Density",
       title = "max growth 16 hours",
       color = "Treatment")
```

Raw data growth curves 90 hours

```{r, echo=F, message=F, warning=F, fig.width=15, fig.height=10}
results2 %>%
  filter(Strain %in% c("LMB2", "NBC")) %>%
  ggplot(aes(x = hrs, y = Density_increase)) +
  geom_line(aes(color = Treatment, linetype = as.factor(Replicate)), stat = "identity", fun.y = mean,  show.legend = TRUE, size = 1) +
  facet_grid(~Strain, scales = "fixed") +
  theme_bw() +
  scale_color_manual(values = c("cornflowerblue", "maroon")) +
  labs(x = "Hours",
       y = "Density",
       title = "Raw data growth curves",
       color = "Strain",
       linetype = "Replicate")
```

Maximal growth 16 hours

```{r, echo=F, message=F, warning=F}
results %>%
  filter(Strain %in% c("LMB2", "NBC")) %>%
  filter(hrs %in% 15.0) %>%
  filter(Treatment != "no") %>%
  ggplot(aes(x = Treatment, y = Density)) +
  geom_boxplot(aes(color = Treatment), show.legend = TRUE) +
  geom_jitter(aes(color = Treatment), width = 0.05) +
  stat_compare_means(label = "p.signif", method = "t.test", ref.group = "DMSO", label.y = 0.5) +
  facet_grid(~Strain, scales = "fixed") +
  theme_bw() +
 scale_color_manual(values = c("cornflowerblue", "maroon")) +
  labs(y = "Density",
       title = "max growth 16 hours",
       color = "Treatment")
```

Area under the curve of 16 hrs of growth

```{r, echo=F, message=F, warning=F}
results %<>%
  # filter(!Strain %in% c("Ignore","None")) %>%
  group_by(Strain, Treatment, Well) %>%
  mutate(Density_increase = Density - Density[1]) %>%
  ungroup %>% as.data.frame()
```

```{r, echo=F, message=F, warning=F, fig.width=7, fig.height=5}
results_AUC_16 <- results %>% filter(hrs < 15.0) %>%
  group_by(Strain, Treatment, Well) %>%
  dplyr::summarize(AUC = auc(hrs, Density_increase),
            AUC_raw = auc(hrs, Density)) %>%
  ungroup %>%
  mutate(Treatment = as.factor(Treatment)) %>%
  mutate(AUC_pos = abs(AUC)) %>%
  mutate(Strain_Treatment = paste(Strain, Treatment, Well)) %>%
  #Split by Rep
  base::split(., .$Strain_Treatment) %>% #Make each strain / rep combination its own data.frame
  map_dfr(~
  mutate(.x, AUC_norm = AUC_pos / AUC_pos[length(AUC_pos)])) %>% #in each df, divide the AUC by the last AUC value; since Control does not start with a number, it is the last treatment
  # left_join(. , Strain_Data %>% dplyr::select(-Strain), by = "Well") %>%
  # mutate(Well_Row = Well %>% str_extract(.,"[A-H]"),
  #                   Well_Col = Well %>% str_extract(.,"[0-9]+") %>% as.numeric()) %>%
  as.data.frame() #transform into df
```

```{r, echo=F, message=F, warning=F, fig.width=7, fig.height=5}
results_AUC_16 %>%
  filter(Treatment != "no") %>%
  filter(Strain %in% c("LMB2", "NBC")) %>%
  ggplot(aes(x = Treatment, y = AUC)) +
  geom_boxplot(aes(fill = Treatment))+
  geom_beeswarm()+
  stat_compare_means(method = "t.test", aes(x = Treatment, y = AUC_raw), label.y = 4.2) +
  stat_compare_means(label = "p.signif", method = "t.test", ref.group = "DMSO", label.y = 4) +
  facet_grid(~Strain, scales = "fixed") +
  theme_bw() +
  scale_fill_manual(values = c("cornflowerblue", "maroon")) +
  labs(y = "AUC",
       title = "AUC 16 hours")
```

Supplementary figure growth LMB2 (AUC over 16 hours)

```{r, echo=F, message=F, warning=F, fig.width=7, fig.height=5}
RNAseq_LMB2_AUC <- results_AUC_16 %>%
  filter(Treatment != "no") %>%
  filter(Strain %in% "LMB2") %>%
  ggplot(aes(x = Treatment, y = AUC)) +
  geom_bar(fill = "#7e0021", alpha = 0.5, stat = "summary", position = "stack", size = 2, show.legend = FALSE) +
  geom_jitter(width = 0.1) +
  stat_compare_means(method = "t.test", aes(x = Treatment, y = AUC), label.y = 1.9) +
  scale_y_continuous(limits = c(0, 2), expand = expansion(mult = c(0, 0)))+
  theme_classic() +
  scale_fill_manual(values = c("cornflowerblue", "maroon"))+
  labs(title = "LMB2",
    y = "AUC",
       x = "")

RNAseq_LMB2_AUC

# ggsave(plot = RNAseq_LMB2_AUC,  filename = "RNAseq_LMB2_AUC.pdf", width = 4, height = 5, dpi = 300, scale = 1, units = "cm")

# ggsave(plot = RNAseq_LMB2_AUC,  filename = "RNAseq_LMB2_AUC.svg", width = 4, height = 5, dpi = 300, scale = 1, units = "cm")
```

Area under the curve of 90 hrs of growth

```{r, echo=F, message=F, warning=F}
results_all %<>%
  # filter(!Strain %in% c("Ignore","None")) %>%
  group_by(Strain, Treatment, Well) %>%
  mutate(Density_increase = Density - Density[1]) %>%
  ungroup %>% as.data.frame()
```

```{r, echo=F, message=F, warning=F, fig.width=7, fig.height=5}
results_AUC_90 <- results_all %>% filter(hrs < 90.0) %>%
  group_by(Strain, Treatment, Well) %>%
  dplyr::summarize(AUC = auc(hrs, Density_increase),
            AUC_raw = auc(hrs, Density)) %>%
  ungroup %>%
  mutate(Treatment = as.factor(Treatment)) %>%
  mutate(AUC_pos = abs(AUC)) %>%
  mutate(Strain_Treatment = paste(Strain, Treatment, Well)) %>%
  base::split(., .$Strain_Treatment) %>% 
  map_dfr(~
  mutate(.x, AUC_norm = AUC_pos / AUC_pos[length(AUC_pos)])) %>% 
  as.data.frame()
```

```{r, echo=F, message=F, warning=F, fig.width=7, fig.height=5}
results_AUC_90 %>%
  filter(Treatment != "no") %>%
  filter(Strain %in% c("LMB2", "NBC")) %>%
  ggplot(aes(x = Treatment, y = AUC_raw)) +
  geom_boxplot(aes(fill = Treatment))+
  geom_point() +
  stat_compare_means(method = "t.test", aes(x = Treatment, y = AUC_raw), label.y = 88) +
  stat_compare_means(label = "p.signif", method = "t.test", ref.group = "DMSO", label.y = 85) +
  facet_grid(~Strain, scales = "fixed") +
  theme_bw() +
  scale_fill_manual(values = c("cornflowerblue", "maroon"))+
  labs(y = "AUC_raw",
       title = "AUC raw 90 hours")
```

Data single plates

```{r, echo=F, message=F, warning=F}
results_plate_1 <-  read_excel("Input/21.07.21_RNAseq_experiment_single_plate.xlsx", sheet = 1, range = "A38:B133", col_names = c("Well", 1:1))
results_plate_1$Plate <- 1

results_plate_2 <-  read_excel("Input/21.07.21_RNAseq_experiment_single_plate.xlsx", sheet = 2, range = "A38:B133", col_names = c("Well", 1:1))
results_plate_2$Plate <- 2

results_plate_3 <-  read_excel("Input/21.07.21_RNAseq_experiment_single_plate.xlsx", sheet = 3, range = "A38:B133", col_names = c("Well", 1:1))
results_plate_3$Plate <- 3

results_plate_4 <-  read_excel("Input/21.07.21_RNAseq_experiment_single_plate.xlsx", sheet = 4, range = "A38:B133", col_names = c("Well", 1:1))
results_plate_4$Plate <- 4

results_plate_5 <-  read_excel("Input/21.07.21_RNAseq_experiment_single_plate.xlsx", sheet = 5, range = "A38:B133", col_names = c("Well", 1:1))
results_plate_5$Plate <- 5
```

```{r, echo=F, message=F, warning=F}
results_plates <- rbind(results_plate_1, results_plate_2, results_plate_3, results_plate_4, results_plate_5)
colnames(results_plates) <- c("Well", "Density", "Plate")

results_plates <- left_join(results_plates, metadata, by ="Well")
```

remove samples which did not grew

```{r, echo=F, message=F, warning=F}
results_plates %<>% mutate(Well_Plate = interaction(Well, Plate, sep = "_"))
```

```{r, echo=F, message=F, warning=F}
results_plates %>%
  filter(!Well_Plate %in% c("E5_1", "F9_3", "D2_3", "E2_3", "F7_4", "D3_4", "B7_5", "F10_2")) %>%
  filter(Strain != "medium") %>%
  ggplot(aes(x = Strain, y = Density)) +
  # stat_summary(geom = "pointrange", fun.y = mean, fun.ymax = max, fun.ymin = min, alpha = 0.5) +
  # geom_text(aes(label = interaction(Well, Plate))) +
  geom_boxplot(aes(fill = Treatment), show.legend = TRUE) +
  geom_jitter(aes(shape = as.factor(Plate)), width = 0.2) +
  # geom_line(aes(color = Treatment, group = Treatment, x = Cycle, y = Density), stat = "summary", fun.y = mean,
     #       show.legend = FALSE)+
  stat_compare_means(label = "p.signif", method = "t.test", ref.group = "NBC", label.y = 1) +
  facet_grid(~Treatment, scales = "fixed") +
  theme_bw() +
 # scale_color_manual(values = "maroon")+
  labs(y = "Density",
       title = "growth 16 hours",
       color = "Treatment",
       shape = "Plate")
```

```{r, echo=F, message=F, warning=F}
results_plates %>%
  filter(Strain != "medium") %>%
  filter(!Well_Plate %in% c("E5_1", "F9_3", "D2_3", "E2_3", "F7_4", "D3_4", "B7_5", "F10_2")) %>%
  ggplot(aes(x = Treatment, y = Density)) +
  # stat_summary(geom = "pointrange", fun.y = mean, fun.ymax = max, fun.ymin = min, alpha = 0.5) +
  # geom_text(aes(label = interaction(Well, Plate))) +
  geom_boxplot(aes(fill = Treatment), show.legend = TRUE) +
  geom_jitter(aes(shape = as.factor(Plate)), width = 0.2) +
  stat_compare_means(method = "t.test", aes(x = Treatment, y = Density), label.y = 0.95)+
  stat_compare_means(label = "p.signif", method = "t.test", ref.group = "DMSO", label.y = 0.85) +
  facet_grid(~Strain, scales = "fixed") +
  theme_bw() +
 # scale_color_manual(values = "maroon")+
  labs(y = "Density",
       title = "growth 16 hours",
       color = "Treatment",
       shape = "Plate")
```

# Bacterial metabolites

```{r, echo=F, message=F, warning=F}
metadata_met <- read_excel("Input/210723_SampleList_Metabolites_RNAseq_bacteria.xlsx", sheet = 1)
```

```{r, echo=F, message=F, warning=F}
data <-  read_excel("Input/20210728_MH_LT_Bact_RNAseq.xlsx", sheet = 1)

data %<>% dplyr::rename(ng_ml = `ng/ul`,
                 Std_conc = `Std. Conc`)

data$Name <- gsub("20210728_MH_LT_Bact_RNAseq_", "", data$Name)

data$ng_ml[is.na(data$ng_ml)] = 0

data_raw <- full_join(metadata_met, data, by = c("Sample_ID" = "Name"))
```

```{r, echo=F, message=F, warning=F}
mol <- read_excel("Input/Molecular_weight_BXDs.xlsx")

data <- left_join(data_raw, mol, by = "Compound")
data %<>% mutate(M = as.numeric(M)) %>% mutate(molar = ((ng_ml/M) /0.04)) %>% as.data.frame()
```

```{r, echo=F, message=F, warning=F, fig.width=7, fig.height=5}
data %>%
  filter(!Strain %in% NA) %>%
  filter(!Compound %in% NA) %>%
  ggplot(aes(x = interaction(Strain, Treatment), y = ng_ml)) +
  geom_boxplot(aes(fill = Treatment)) +
  geom_jitter(width = 0.1) +
  facet_wrap(~Compound, scales = "fixed") +
  theme_bw()+
  theme(axis.text.x=element_text(angle = -90, hjust = 0, vjust = 0.5))
```

```{r, echo=F, message=F, warning=F, fig.width=7, fig.height=5}
data %>%
  # filter(!Strain %in% NA) %>%
  # filter(!Compound %in% NA) %>%
  filter(Treatment %in% "MBOA") %>%
  ggplot(aes(x = Strain, y = ng_ml)) +
  # stat_summary(geom = "pointrange", fun.y = mean, fun.ymax = max, fun.ymin = min, alpha = 0.5) +
  geom_boxplot(aes(fill = Treatment)) +
  geom_jitter(width = 0.1) +
  # geom_line(aes(color = Treatment, group = Treatment, x = Cycle, y = Density), stat = "summary", fun.y = mean,
     #       show.legend = FALSE)+
  facet_wrap(~Compound, scales = "fixed") +
  theme_bw() +
  theme(axis.text.x=element_text(angle = -90, hjust = 0, vjust = 0.5))
```

```{r, echo=F, message=F, warning=F, fig.width=7, fig.height=5}
data %>%
  ggplot(aes(x = interaction(Strain, Treatment), y = ng_ml)) +
  geom_bar(aes(fill = Treatment), stat = "summary", position = "dodge",  show.legend = FALSE) +
  geom_errorbar(stat = "summary", position = position_dodge(width = 1), width=0.25) +
  geom_jitter(width = 0.1) +
  facet_wrap(~Compound, scales = "fixed") +
  theme_bw() +
  theme(axis.text.x=element_text(angle = -90, hjust = 0, vjust = 0.5))
```

```{r, echo=F, message=F, warning=F, fig.width=7, fig.height=5}
data %>%
  filter(Treatment %in% "MBOA") %>%
  ggplot(aes(x = Strain, y = ng_ml)) +
  geom_bar(aes(fill = Treatment), stat = "summary", position = "dodge",  show.legend = FALSE) +
  geom_errorbar(stat = "summary", position = position_dodge(width = 1), width=0.25) +
  geom_jitter(width = 0.1) +
  facet_wrap(~Compound, scales = "fixed") +
  theme_bw() +
  theme(axis.text.x=element_text(angle = -90, hjust = 0, vjust = 0.5))
```

Supplementary figure metabolisation

```{r, echo=F, message=F, warning=F, fig.width=7, fig.height=5}
RNAseq_LMB2_met <- data %>%
  # filter(!Strain %in% NA) %>%
  # filter(!Compound %in% NA) %>%
  filter(Strain %in% c("LMB2", "NBC")) %>%
  filter(Compound %in% c("MBOA", "AMPO", "AAMPO", "MHPA")) %>%
  filter(Treatment %in% "MBOA") %>%
  ggplot(aes(x = Strain, y = molar)) +
  geom_bar(aes(fill = Compound), stat = "summary", position = "stack", show.legend = TRUE) +
  geom_jitter(width = 0.1) +
  theme_classic() +
  theme(axis.text.x=element_text(angle = 0)) +
  scale_fill_manual(values = c("firebrick1", "darkred", "darkblue", "gold2"))+
  scale_colour_manual(values = "grey50") +
  scale_y_continuous(limits = c(0, 600), expand = expansion(mult = c(0, 0)))+
  labs(y = "Concentration",
       x = "")


RNAseq_LMB2_met

# ggsave(plot = RNAseq_LMB2_met, filename = "RNAseq_LMB2_met.pdf", width = 6.6, height = 8, dpi = 300, scale = 1, units = "cm")
#
# ggsave(plot = RNAseq_LMB2_met, filename = "RNAseq_LMB2_met.svg", width = 6.6, height = 8, dpi = 300, scale = 1, units = "cm")
```

```{r}
sessionInfo()
```

