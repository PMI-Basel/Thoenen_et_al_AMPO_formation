---
title: "AtSphere Bacteria BX metabolites"
subtitle: "Thoenen_et_al_Bacteria_BX_metabolization"
author: "Lisa ThÃ¶nen"
date: "`r Sys.Date()`"
output: 
  html_document:
    fig_caption: yes
    toc: true
    toc_float: true
    theme: cerulean
    code_folding: show
editor_options: 
  chunk_output_type: console
---

Here we plot the results of the MBOA to AMPO screen AtSphere bacteria using the metabolite assay in liquid cultures. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup
```{r, include=FALSE}
rm(list = ls())
```

```{r,include=FALSE}
# install.packages("dplyr") 
# install.packages("magrittr") # for the %>% function
# install.packages("ggplot2") # plots
# install.packages("readxl") # to read excels
# install.packages("stringr")
# install.packages("MESS") # for auc function
# install.packages("purrr")
# install.packages("multcomp")
# install.packages("emmeans")
# install.packages("ggpubr")
# install.packages("forcats")
# install.packages("readr")
# install.packages("ggpmisc")
# install.packages("pander")
# install.packages("rstatix")
```

```{r,include=FALSE}
library("dplyr")
library("magrittr")
library("ggplot2")
library("readxl")
library("tidyr")
library("readr")
library("stringr")
library("MESS") 
library("purrr")
library("multcomp")
library("emmeans")
library("ggpubr")
library("forcats")
library("readr")
library("ggpmisc")
library("pander")
library("rstatix")
```

# Data
```{r, message=FALSE, echo=FALSE, error=FALSE, warning = FALSE}
# Metadata
metadata <- read_excel("Input/AtSphere_AMPOformation.xlsx", sheet = 1)
# Metabolite data
met <- read_excel("Input/20230815_AtSphere_metabolites_quant.xlsx")
# Molecular weights
mol <- read_excel("Input/Molecular_weight_BXDs.xlsx")
```

```{r, warning=F, echo=F, message=F}
met %<>% dplyr::rename(Std_conc = `Std. Conc`)
# met %>% colnames()
# met$Compound %>% unique() # %>% length()
# met %<>% filter(!Compound %in% c("MBOA-Glc", "HMPMA", "AAPO")) 
```

## Slopes for quantification
using a standard curve the samples are quantified

```{r, warning=F, echo=F, message=F}
met_Std <- met %>% 
  # mutate(Type = as.factor(Type)) %>% 
  filter(Type %in% "Standard") %>% 
  # filter(Std_conc %in% "0") %>% 
  filter(!Compound %in% c("DIBOA-Glc", "HDM2BOA-Glc", "DIM2BOA-Glc")) %>% 
  # filter(!Name %in% c("20211123_MH_LT_Bact_MHPA_40ng", "20211123_MH_LT_Bact_MHPA_200ng", "20211123_MH_LT_Bact_MHPA_1000ng")) %>% 
  dplyr::select(Std_conc, Area, Compound)
```

```{r, warning=F, echo=F, message=F}
# met_Std <- rbind(met_Std, met_Zero)
met_Std %<>% filter(!Std_conc %in% "NA")
```

```{r, warning=F, echo=F, message=F}
met_Std %>% as.data.frame() %>% 
  filter(!Compound %in% c("DIBOA-Glc", "HDM2BOA-Glc", "MAPH", "MHPA", "DIM2BOA-Glc", "HBOA-Glc", "HM2BOA-Glc", "HMBOA-Glc")) %>% 
  mutate(Std_conc = as.numeric(Std_conc)) %>% 
  mutate(Area = as.numeric(Area)) %>% 
  ggplot(aes(x= Std_conc, y = Area)) + 
  geom_point(aes(colour = Compound), show.legend = FALSE) +
  geom_smooth(method = "lm", color="black", formula = y ~ 0 + x) +
  stat_poly_eq(formula = y ~ 0 + x,
                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                parse = TRUE, label.y.npc = "top", label.x.npc = "left") +
  stat_fit_glance(method = "lm", method.args = list(formula = y ~ 0 + x),
                      geom = 'text', aes(label = paste("P-val. = ", 
                      signif(..p.value.., digits = 4), sep = "")), label.y = "bottom", label.x = "center") +
  facet_wrap(~Compound, scales = "free") +
  labs(y = "Area",
       x = "Concentration")
```

```{r, warning=F, echo=F, message=F}
met_Std$Area <- gsub("NA", "0", met_Std$Area)
```

```{r, warning=F, echo=F, message=F}
St_slopes <- met_Std %>%
  filter(!Compound %in% c("MHPA", "DIBOA-Glc", "HDM2BOA-Glc", "MAPH", "MHPA", "DIM2BOA-Glc", "HBOA-Glc", "HM2BOA-Glc", "HMBOA-Glc")) %>% 
  mutate(Compound = as.factor(Compound)) %>% 
  mutate(Std_conc = as.numeric(Std_conc)) %>%
  group_by(Compound) %>% 
  do(lm(Area ~ 0 + Std_conc,  data = .) %>%  coef() %>%   as.data.frame() %>% slice(1))
```

```{r, warning=F, echo=F, message=F}
colnames(St_slopes) <- c("Compound", "Slope")
```

```{r, warning=F, echo=F, message=F}
met$Name <- gsub("20230815_PM_LT_AtSphere_AMPOformation_", "", met$Name)
met$Name <- gsub("20230815_PM_LT_AtSphere_AMPOformation_PM11xStds2IS_", "", met$Name)
met$Name <- gsub("LRC7_O_D", "LRC7.O_D", met$Name)
met$Name <- gsub("LRC7_O_M", "LRC7.O_M", met$Name)

# met$Name <- gsub("20220125_MH_LT_HEX_metabolites_", "", met$Name)
# met$Name <- gsub("smpl_", "", met$Name)
met %<>% filter(Type %in% "Analyte")
met <- left_join(met, mol, by = "Compound")
met %<>% mutate(M = as.numeric(M)) # NAs can not be mutated to numeric, a small error message pops up
```

```{r, warning=F, echo=F, message=F}
metadata %<>% dplyr::rename(Name = Sample_ID)
met <- left_join(met, metadata, by = "Name")
# met %<>% mutate(Dilution = as.numeric(Dilution))
met %<>% as.data.frame()
```

```{r, warning=F, echo=F, message=F}
met <- left_join(met, St_slopes, by = "Compound")
```

```{r, warning=F, echo=F, message=F}
met$cols <- as.character(met$Compound)
met[met$Compound == "AMPO", ]$cols <- "darkred"
met[met$Compound == "AAMPO", ]$cols <- "firebrick1"
#met[met$Compound == "MHPA", ]$cols <- "gold2"
met[met$Compound == "MBOA", ]$cols <- "darkblue"
#met[met$Compound == "MAPH", ]$cols <- "darkorange"

met[met$Compound == "HMBOA", ]$cols <- "skyblue"
met[met$Compound == "BOA", ]$cols <- "slateblue"
met[met$Compound == "MBOA-Glc", ]$cols <- "darkmagenta"


met[met$Compound == "HMPMA", ]$cols <-  "slategray"
met[met$Compound == "DIMBOA", ]$cols <-  "slategray"
met[met$Compound == "APO", ]$cols <-  "slategray"
# met[met$Compound == "AAPO", ]$cols <-  "slategray"

met[met$Compound == "DIMBOA-Glc", ]$cols <-  "slategray"
met[met$Compound == "HDMBOA-Glc", ]$cols <-  "slategray"
met[met$Compound == "HBOA-Glc", ]$cols <-  "slategray"
met[met$Compound == "DIBOA-Glc", ]$cols <-  "slategray"
met[met$Compound == "HMBOA-Glc", ]$cols <-  "slategray"
met[met$Compound == "HM2BOA-Glc", ]$cols <-  "slategray"
met[met$Compound == "DIM2BOA-Glc", ]$cols <-  "slategray"
met[met$Compound == "HDM2BOA-Glc", ]$cols <-  "slategray"

temp <- data.frame(met$Compound, met$cols)
temp <- plyr::ddply(temp, .variables="met.Compound", .fun=unique)   #library(plyr)
level_cols_Compound <- as.character(temp[,2])
names(level_cols_Compound) <- temp[,1]
```

```{r, warning=F, echo=F, message=F}
#met$Area_sample <- as.numeric(met$Area) / 0.0075 # Check again how to calculate dilution, reconfirm with tecan metabolite script
met$Area_sample <- as.numeric(met$Area)
met$ng_sample <- met$Area_sample / met$Slope 
#met$uMol <- (met$ng_sample) / met$M
met$uMol <- ((met$ng_sample) / met$M) / 0.02
```

```{r, warning=F, echo=F, message=F}
met_AtSphere <- met %>% filter(Strain != "NA") # Subset AtSphere experiment
```


# All metabolites in all compounds

```{r, message=FALSE, echo=FALSE, error=FALSE, warning = FALSE}
met_AtSphere %>% 
  mutate(Compound = as.factor(Compound)) %>% 
  # filter(Compound %in% "MBOA") %>% 
  # filter(Strain %in% "LAC11") %>% 
  # filter(Treatment %in% "MBOA_high") %>% 
  ggplot(aes(x = Strain, y = as.numeric(Area), group = Treatment)) +
  geom_point(aes(colour = Treatment), show.legend = TRUE) +
  # geom_jitter(width=0.1) +
  # geom_errorbar(stat = "summary", position= "dodge", width=0.25) +
  facet_wrap(~ Compound, scales = "free") +
  scale_fill_manual(values = c("darkblue", "darkred"))+
  theme_bw() +
  theme(axis.text.x=element_text(angle = -90, hjust = 0, vjust = 0 )) 
  
```

```{r, message=FALSE, echo=FALSE, error=FALSE, warning = FALSE}
met %>% 
  # mutate(Compound = as.factor(Compound)) %>% 
  mutate(Area = as.numeric(Area)) %>% 
  filter(Strain != "NA") %>% 
  # filter(Compound %in% c("MBOA", "AAMPO", "AMPO", "MHPA")) %>% 
  # filter(Strain %in% c("SCS", "SCR")) %>% 
  # filter(Treatment %in% "MBOA_high") %>% 
  ggplot(aes(x = Strain, y = uMol, group = Compound)) +
  geom_point(aes(colour = Compound), stat = "identity", size = 2, show.legend = TRUE) +
  # geom_path(aes(colour = Compound), stat = "summary") +
  # facet_wrap(~ Strain, scales = "fixed") +
  # scale_colour_manual(values = c("darkorange", "darkred", "darkblue", "tomato"))+
  theme_bw() +
  theme(axis.text.x=element_text(angle = -90, hjust = 0, vjust = 0 )) 
```

```{r, message=FALSE, echo=FALSE, error=FALSE, warning = FALSE}
met %<>% filter(!Compound %in% c("APO", "DIBOA-Glc", "DIM2BOA-Glc", "DIMBOA", "DIMBOA-Glc", "HMBOA-Glc", "HDM2BOA-Glc", "HDMBOA-Glc", "HM2BOA-Glc", "HMBOA", "HMBOA-Glc"))
```

These compounds were not detected in the analysis and therefore removed from the analysis from here
AAMPO, APO, DIBOA-Glc, DIM2BOA-Glc, DIMBOA, DIMBOA-Glc, HMBOA-Glc, HDM2BOA-Glc, HDMBOA-Glc, HM2BOA-Glc, HMBOA, HMBOA-Glc


```{r, message=FALSE, echo=FALSE, error=FALSE, warning = FALSE}
met %>% 
  filter(Treatment %in% "MBOA") %>% 
  ggplot(aes(x = interaction(Strain, Genus), y = as.numeric(Area))) +
  geom_bar(aes(fill = Compound), stat = "identity", size = 2, show.legend = TRUE) +
  # geom_path(aes(colour = Compound), stat = "summary") +
  scale_fill_manual(values = level_cols_Compound)+
  theme_bw() +
  theme(axis.text.x=element_text(angle = -90, hjust = 0, vjust = 0 )) +
  labs(x = "")
```

# quantified compounds 

```{r, message=FALSE, echo=FALSE, error=FALSE, warning = FALSE}
met %<>% mutate(Origin = as.factor(Origin))
```


```{r, message=FALSE, echo=FALSE, error=FALSE, warning = FALSE}
metplot <- met %>%
  filter(!Strain %in% NA) %>% 
mutate(Strain_Genus = interaction(Strain, Genus)) %>%
          mutate(Strain_Genus = factor(Strain_Genus, levels =    c("LMB2.Microbacterium", #ok
        "LSP13.Sphingobium",#ok
        "LAC11.Acinetobacter",#ok
        "LRC7.O.Agrobacterium",
        "Root231.Sinorhizobium",#ok
        "Root1280.Acinetobacter",#ok
        "Leaf131.Xanthomonas",#ok
        "Root83.Achromobacter",#ok
        "Leaf130.Acinetobacter",
        "Root434.Variovorax",#ok
        "Leaf51.Rahnella",#ok
        "Root1240.Agrobacterium",#ok
        "Leaf70.Xanthomonas",#ok
        "Leaf53.Erwinia", #ok
        "Root149.Rhizobium",#ok
        "Root651.Agrobacterium",#ok
        "Root318.Variovorax",#ok
        "Root401.Pseudomonas",#ok
        "Root564.Agrobacterium",#ok
        "NBC.NA"
        ))) %>% 
  filter(Treatment %in% "MBOA") %>% 
  ggplot(aes(x = Strain_Genus, y = uMol)) +
  geom_bar(stat = "identity", show.legend = TRUE) +
  # geom_path(aes(colour = Compound), stat = "summary") +
  # geom_tile(fill = "black", height = 50)+
  # geom_line(size=6) +
  #annotate(ymin = 0, ymax = 1, geom = "rect",  fill = c("green", "yellow", "grey")) +
  scale_fill_manual(values = level_cols_Compound)+
  # scale_y_continuous(limits = c(0, 500), expand = expansion(mult = c(0, 0)))+
  scale_y_continuous(limits = c(0, NA), expand = expansion(mult = c(0, 0.2)))+
  theme_bw() +
  theme(axis.text.x=element_text(angle = -90, hjust = 0, vjust = 0 )) +
  labs(x = "")

metplot
```


```{r, message=FALSE, echo=FALSE, error=FALSE, warning = FALSE}
mettileAtSphere <- 
met %>%
  filter(!Strain %in% NA) %>% 
mutate(Strain_Genus = interaction(Strain, Genus)) %>%
          mutate(Strain_Genus = factor(Strain_Genus, levels =    c("LMB2.Microbacterium", #ok
        "LSP13.Sphingobium",#ok
        "LAC11.Acinetobacter",#ok
        "LRC7.O.Agrobacterium",
        "Root231.Sinorhizobium",#ok
        "Root1280.Acinetobacter",#ok
        "Leaf131.Xanthomonas",#ok
        "Root83.Achromobacter",#ok
        "Leaf130.Acinetobacter",
        "Root434.Variovorax",#ok
        "Leaf51.Rahnella",#ok
        "Root1240.Agrobacterium",#ok
        "Leaf70.Xanthomonas",#ok
        "Leaf53.Erwinia", #ok
        "Root149.Rhizobium",#ok
        "Root651.Agrobacterium",#ok
        "Root318.Variovorax",#ok
        "Root401.Pseudomonas",#ok
        "Root564.Agrobacterium",#ok
        "NBC.NA"
        ))) %>%
  ggplot()+
  geom_tile(aes(x= Strain_Genus, y = 50, fill = Origin), height = 20) +
  scale_fill_manual(values = c("#3e5437", "tan3", "grey"), labels = c("maize", "arabidopsis", "other"), name = "Host plant") +
  theme(axis.text.x=element_text(angle = -90, hjust = 0, vjust = 0 ))

mettileAtSphere

# ggsave(plot = mettileAtSphere, filename = "mettileAtSphere.pdf", width = 16.6, height = 12, dpi = 300, scale = 1, units = "cm")
# 
# ggsave(plot = mettileAtSphere, filename = "mettileAtSphere.svg", width = 16.6, height = 12, dpi = 300, scale = 1, units = "cm")
```

```{r, message=FALSE, echo=FALSE, error=FALSE, warning = FALSE}
mettileAtSphereAMPO <- 
met %>%
  filter(!Strain %in% NA) %>% 
mutate(Strain_Genus = interaction(Strain, Genus)) %>%
          mutate(Strain_Genus = factor(Strain_Genus, levels =    c("LMB2.Microbacterium", #ok
        "LSP13.Sphingobium",#ok
        "LAC11.Acinetobacter",#ok
        "LRC7.O.Agrobacterium",
        "Root231.Sinorhizobium",#ok
        "Root1280.Acinetobacter",#ok
        "Leaf131.Xanthomonas",#ok
        "Root83.Achromobacter",#ok
        "Leaf130.Acinetobacter",
        "Root434.Variovorax",#ok
        "Leaf51.Rahnella",#ok
        "Root1240.Agrobacterium",#ok
        "Leaf70.Xanthomonas",#ok
        "Leaf53.Erwinia", #ok
        "Root149.Rhizobium",#ok
        "Root651.Agrobacterium",#ok
        "Root318.Variovorax",#ok
        "Root401.Pseudomonas",#ok
        "Root564.Agrobacterium",#ok
        "NBC.NA"
        ))) %>%
  ggplot()+
  geom_tile(aes(x= Strain_Genus, y = 50, fill = AMPO_former), height = 20) +
  scale_fill_manual(values = c("grey", "lightgoldenrod", "tomato1", "darkred"), labels = c("not tested", "no", "weak", "strong"), name = "Host plant")+
  theme(axis.text.x=element_text(angle = -90, hjust = 0, vjust = 0 ))

mettileAtSphereAMPO

# ggsave(plot = mettileAtSphereAMPO, filename = "mettileAtSphereAMPO.pdf", width = 16.6, height = 12, dpi = 300, scale = 1, units = "cm")
# 
# ggsave(plot = mettileAtSphereAMPO, filename = "mettileAtSphereAMPO.svg", width = 16.6, height = 12, dpi = 300, scale = 1, units = "cm")
```


```{r, message=FALSE, echo=FALSE, error=FALSE, warning = FALSE}
metplotAtSphere <- met %>%
  filter(!Strain %in% NA) %>% 
  mutate(Strain_Genus = interaction(Strain, Genus)) %>%
          mutate(Strain_Genus = factor(Strain_Genus, levels =    
      c("LMB2.Microbacterium", #ok
        "LSP13.Sphingobium",#ok
        "LAC11.Acinetobacter",#ok
        "LRC7.O.Agrobacterium",
        "Root231.Sinorhizobium",#ok
        "Root1280.Acinetobacter",#ok
        "Leaf131.Xanthomonas",#ok
        "Root83.Achromobacter",#ok
        "Leaf130.Acinetobacter",
        "Root434.Variovorax",#ok
        "Leaf51.Rahnella",#ok
        "Root1240.Agrobacterium",#ok
        "Leaf70.Xanthomonas",#ok
        "Leaf53.Erwinia", #ok
        "Root149.Rhizobium",#ok
        "Root651.Agrobacterium",#ok
        "Root318.Variovorax",#ok
        "Root401.Pseudomonas",#ok
        "Root564.Agrobacterium",#ok
        "NBC.NA"
        ))) %>% 
  filter(Treatment %in% "MBOA") %>% 
  ggplot(aes(x = Strain_Genus, y = uMol)) +
  geom_bar(aes(fill = Compound), stat = "identity", show.legend = TRUE) +
  # geom_path(aes(colour = Compound), stat = "summary") +
  # geom_tile(fill = "black", height = 50)+
  # geom_line(size=6) +
  #annotate(ymin = 0, ymax = 1, geom = "rect",  fill = c("green", "yellow", "grey")) +
  scale_fill_manual(values = level_cols_Compound)+
  # scale_y_continuous(limits = c(0, 500), expand = expansion(mult = c(0, 0)))+
  scale_y_continuous(limits = c(0, NA), expand = expansion(mult = c(0, 0.2)))+
  theme_bw() +
  theme(axis.text.x=element_text(angle = -90, hjust = 0, vjust = 0 )) +
  labs(x = "")

metplotAtSphere

# ggsave(plot = metplotAtSphere, filename = "metplotAtSphere.pdf", width = 16.6, height = 12, dpi = 300, scale = 1, units = "cm")
# 
# ggsave(plot = metplotAtSphere, filename = "metplotAtSphere.svg", width = 16.6, height = 12, dpi = 300, scale = 1, units = "cm")
```


```{r}
sessionInfo()
```

